<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHall v22</title>

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- THEME VARIABLES (Light Mode Default) --- */
        :root {
            --bg-body: #F9F9F9;       
            --bg-sidebar: #FFFFFF;    
            --bg-card: #FFFFFF;       
            --bg-input: #F3F4F6;      
            --text-main: #374151;     
            --text-muted: #9CA3AF;    
            --accent: #FF9F43;        
            --accent-hover: #FF7F00;  
            --success: #10B981;       
            --danger: #EF4444;
            --paper-bg: #FFFFFF;
            --radius: 24px;
            --font: 'Nunito', sans-serif;
            --shadow: 0 4px 30px rgba(0,0,0,0.04); 
            --border: 1px solid #E5E7EB;
        }

        [data-theme="dark"] {
            --bg-body: #1F2937;
            --bg-sidebar: #111827;
            --bg-card: #374151;
            --bg-input: #4B5563;
            --text-main: #F9FAFB;
            --text-muted: #9CA3AF;
            --accent: #FCD34D;       
            --accent-hover: #F59E0B; 
            --success: #34D399;       
            --danger: #F87171;        
            --paper-bg: #374151;      
            --shadow: 0 4px 30px rgba(0,0,0,0.4);
            --border: 1px solid #4B5563;
        }

        * { box-sizing: border-box; transition: all 0.2s ease; outline: none; }
        body { margin: 0; font-family: var(--font); background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- AUTH SCREEN --- */
        #auth-screen { position: fixed; inset: 0; background: var(--bg-body); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .auth-card { background: var(--bg-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; border: var(--border); }
        .auth-title { font-size: 2rem; font-weight: 800; color: var(--accent); margin-bottom: 10px; }
        .auth-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid var(--bg-input); background: var(--bg-input); color: var(--text-main); font-size: 1rem; }
        .auth-link { color: var(--text-muted); font-size: 0.9rem; cursor: pointer; margin-top: 15px; display: block; text-decoration: underline; }

        /* --- SIDEBAR --- */
        .sidebar { width: 250px; background: var(--bg-sidebar); display: flex; flex-direction: column; padding: 30px 20px; flex-shrink: 0; border-right: var(--border); }
        .app-title { font-size: 1.3rem; font-weight: 800; color: var(--accent); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
        .nav-link { display: flex; align-items: center; gap: 15px; padding: 12px 15px; margin-bottom: 5px; border-radius: 15px; color: var(--text-muted); cursor: pointer; font-weight: 600; font-size: 0.95rem; border: none; background: none; width: 100%; text-align: left; }
        .nav-link:hover { background: var(--bg-input); color: var(--text-main); }
        .nav-link.active { background: var(--bg-input); color: var(--accent); font-weight: 800; }

        /* --- USER AREA --- */
        .spacer { flex: 1; }
        .user-area { display: flex; align-items: center; gap: 10px; padding-top: 20px; border-top: var(--border); }
        .avatar-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: var(--bg-input); cursor: pointer; }
        .user-info { flex: 1; overflow: hidden; }
        .user-name { font-weight: 700; font-size: 0.9rem; white-space: nowrap; }
        .user-coins { font-size: 0.8rem; color: var(--accent); font-weight: 700; }

        /* --- MAIN --- */
        .main { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; max-width: 1200px; margin: 0 auto; width: 100%; }
        .header { margin-bottom: 30px; }
        .header h1 { font-size: 2rem; margin: 0; font-weight: 800; letter-spacing: -1px; }
        .quote-box { color: var(--text-muted); font-size: 0.95rem; margin-top: 5px; }

        .card { background: var(--bg-card); border-radius: var(--radius); padding: 30px; margin-bottom: 25px; box-shadow: var(--shadow); border: var(--border); }

        /* --- CLEAN WIDGETS --- */
        .grid-main { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        
        /* XP Bar */
        .xp-container { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .xp-track { flex: 1; background: var(--bg-input); height: 8px; border-radius: 10px; overflow: hidden; }
        .xp-fill { background: var(--accent); width: 0%; height: 100%; border-radius: 10px; }
        .lvl-badge { background: var(--accent); color: white; padding: 4px 10px; border-radius: 10px; font-weight: 800; font-size: 0.8rem; }

        /* Tasks */
        .todo-input { width: 100%; background: var(--bg-input); border: none; padding: 15px; border-radius: 15px; color: var(--text-main); font-weight: 600; margin-bottom: 15px; }
        .todo-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--bg-input); }
        .todo-check { width: 20px; height: 20px; border: 2px solid var(--text-muted); border-radius: 6px; margin-right: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .todo-item.done .todo-check { background: var(--success); border-color: var(--success); color: white; }
        .todo-item.done span { text-decoration: line-through; color: var(--text-muted); }
        .todo-del { margin-left: auto; color: var(--text-muted); cursor: pointer; font-size: 0.9rem; }
        .todo-del:hover { color: var(--danger); }

        /* Pet */
        .pet-card { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; position: relative; text-align: center; }
        .pet-display { font-size: 4.5rem; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); margin: 10px 0; }
        .pet-msg { font-size: 0.9rem; font-weight: 700; color: var(--text-muted); }

        /* Buttons */
        .btn { padding: 12px 25px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 0.95rem; background: var(--bg-input); color: var(--text-main); display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(255, 159, 67, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 159, 67, 0.4); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-full { width: 100%; }

        /* Notes */
        #notepad { width: 100%; height: 65vh; background: transparent; color: var(--text-main); padding: 0; border: none; font-family: 'Nunito', sans-serif; line-height: 1.6; font-size: 1.1rem; resize: none; }
        
        /* Utils */
        .hidden { display: none !important; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .shop-item { background: var(--bg-input); border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .shop-item.equipped { border-color: var(--accent); background: var(--bg-card); }

    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <div class="auth-title"><i class="fas fa-shapes"></i> StudyHall</div>
            <p style="color:var(--text-muted); margin-bottom:25px;">Sign in to access your space.</p>
            
            <div id="login-form">
                <input type="email" id="login-email" class="auth-input" placeholder="Email">
                <input type="password" id="login-pass" class="auth-input" placeholder="Password">
                <button class="btn btn-primary btn-full" onclick="login()">Log In</button>
                <span class="auth-link" onclick="toggleAuthMode()">Create an account</span>
            </div>

            <div id="register-form" class="hidden">
                <input type="text" id="reg-name" class="auth-input" placeholder="Choose a Username">
                
                <input type="email" id="reg-email" class="auth-input" placeholder="Email">
                <input type="password" id="reg-pass" class="auth-input" placeholder="Password">
                <button class="btn btn-primary btn-full" onclick="register()">Sign Up</button>
                <span class="auth-link" onclick="toggleAuthMode()">Back to Login</span>
            </div>
            <p id="auth-error" style="color:var(--danger); font-size:0.8rem; margin-top:15px;"></p>
        </div>
    </div>

    <div id="app-screen" class="hidden" style="display:flex; width:100%; height:100%;">
        
        <nav class="sidebar">
            <div class="app-title"><i class="fas fa-shapes"></i> StudyHall</div>
            <button class="nav-link active" onclick="showPage('home', this)"><i class="fas fa-home"></i> Dashboard</button>
            <button class="nav-link" onclick="showPage('notes', this)"><i class="fas fa-pencil-alt"></i> Notes</button>
            <button class="nav-link" onclick="showPage('focus', this)"><i class="fas fa-clock"></i> Timer</button>
            <button class="nav-link" onclick="showPage('shop', this)"><i class="fas fa-store"></i> Market</button>
            <button class="nav-link" onclick="showPage('settings', this)"><i class="fas fa-cog"></i> Settings</button>
            
            <div class="spacer"></div>
            
            <div class="user-area">
                <div class="avatar-container" onclick="document.getElementById('file-input').click()">
                    <img src="" id="user-avatar" class="avatar-img">
                </div>
                <div class="user-info">
                    <div class="user-name" id="sidebar-name">Student</div>
                    <div class="user-coins"><i class="fas fa-coins"></i> <span id="coin-display">0</span></div>
                </div>
            </div>
        </nav>
        <input type="file" id="file-input" accept="image/*" onchange="uploadAvatar(this)" style="display:none;">

        <main class="main">
            <div class="header">
                <h1 id="page-title">Dashboard</h1>
                <div class="quote-box" id="daily-quote">Loading...</div>
            </div>

            <div id="home" class="page">
                <div class="grid-main">
                    <div>
                        <div class="card">
                            <div class="xp-container">
                                <div class="lvl-badge" id="lvl-display">LVL 1</div>
                                <div class="xp-track"><div id="xp-bar" class="xp-fill"></div></div>
                                <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted);" id="xp-text">0/1000</div>
                            </div>
                            <h3 style="margin-top:0; font-size:1.1rem;">Tasks</h3>
                            <input type="text" id="todo-input" class="todo-input" placeholder="What needs to be done?" onkeypress="if(event.key==='Enter') addTask()">
                            <div id="todo-list"></div>
                        </div>
                    </div>

                    <div>
                        <div class="card pet-card">
                            <div class="pet-display" id="pet-display">üê∂</div>
                            <div class="pet-msg" id="pet-msg">Ready to focus?</div>
                        </div>
                        <div class="card" style="text-align:center; padding:20px;">
                            <div style="font-size:2rem; font-weight:800; color:var(--accent);" id="streak-display">0</div>
                            <div style="font-size:0.8rem; color:var(--text-muted); font-weight:700;">DAY STREAK</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="notes" class="page hidden">
                <div class="card" style="height:100%;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <span style="color:var(--text-muted); font-size:0.9rem;">Changes save automatically.</span>
                        <button class="btn" style="padding:5px 15px; font-size:0.8rem;" onclick="exportNotes()">Download</button>
                    </div>
                    <textarea id="notepad" placeholder="Start typing..." oninput="handleNoteInput()"></textarea>
                </div>
            </div>

            <div id="focus" class="page hidden">
                <div class="card" style="text-align:center; padding:60px 20px;">
                    <div style="font-size:5rem; font-weight:800; color:var(--text-main); margin-bottom:10px;" id="timer-display">25:00</div>
                    <p style="color:var(--text-muted); margin-bottom:30px;">STAY FOCUSED</p>
                    <div style="display:flex; justify-content:center; gap:15px;">
                        <button class="btn" onclick="adjustTime(-5)">-5</button>
                        <button class="btn btn-primary" id="btn-toggle" onclick="toggleTimer()" style="min-width:150px;">Start</button>
                        <button class="btn" onclick="adjustTime(5)">+5</button>
                    </div>
                </div>
            </div>

            <div id="shop" class="page hidden">
                <div class="shop-grid" id="shop-container"></div>
            </div>

            <div id="settings" class="page hidden">
                <div class="card">
                    <h3>Appearance</h3>
                    <button class="btn" onclick="toggleTheme()" id="theme-btn">Switch to Dark Mode</button>
                </div>
                <div class="card">
                    <h3>Account</h3>
                    <p style="color:var(--text-muted); font-size:0.9rem;">Logged in as: <span id="uid-display">...</span></p>
                    <button class="btn btn-danger" onclick="logout()">Log Out</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8-gihD7c9ARk_EVqcFIveFHqegiFStGQ",
            authDomain: "study-hall-101.firebaseapp.com",
            databaseURL: "https://study-hall-101-default-rtdb.firebaseio.com",
            projectId: "study-hall-101",
            storageBucket: "study-hall-101.firebasestorage.app",
            messagingSenderId: "1008777949689",
            appId: "1:1008777949689:web:0fdc8c099374b695754d28",
            measurementId: "G-K22V4HCKRQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let dbRef = null;

        // AUTH STATE LISTENER
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                dbRef = ref(db, 'users/' + user.uid);
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('app-screen').style.display = 'flex';
                document.getElementById('uid-display').innerText = window.state.username || user.email;

                // Load Data
                onValue(dbRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        window.state = { ...window.state, ...data };
                        // Backwards compatibility
                        if(!window.state.inventory) window.state.inventory = ['pet_dog'];
                        if(!window.state.todos) window.state.todos = [];
                        if(!window.state.username) window.state.username = "Student";
                        
                        // Render
                        window.renderShop();
                        window.renderTodos();
                        window.updateUI();
                        document.body.setAttribute('data-theme', window.state.theme || 'light');
                        document.getElementById('notepad').value = window.state.notes || '';
                    } else {
                        // Data might not be there instantly on creation, wait for register func to set it
                    }
                });
                window.init();
            } else {
                // User is signed out
                currentUser = null;
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        // AUTH FUNCTIONS
        window.register = async () => {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;

            if(!name) {
                document.getElementById('auth-error').innerText = "Please enter a username.";
                return;
            }

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                // Create initial DB state immediately
                const newUserState = {
                    username: name,
                    xp: 0, lvl: 1, coins: 0, streak: 1, lastLogin: new Date().toDateString(),
                    inventory: ['pet_dog'], equippedPet: 'pet_dog', 
                    theme: 'light', todos: [], notes: ''
                };
                await set(ref(db, 'users/' + cred.user.uid), newUserState);
            } catch (e) { document.getElementById('auth-error').innerText = e.message; }
        };

        window.login = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) { document.getElementById('auth-error').innerText = "Invalid Login. Check email/password."; }
        };

        window.logout = () => signOut(auth);

        window.saveData = function() {
            if(currentUser && dbRef) set(dbRef, window.state);
        }
    </script>

    <script>
        window.state = {
            username: 'Student',
            xp: 0, lvl: 1, coins: 0, streak: 1, lastLogin: '',
            inventory: ['pet_dog'], equippedPet: 'pet_dog', 
            theme: 'light', todos: [], notes: ''
        };

        const quotes = ["Make it happen.", "Focus on the Good.", "Dream Big.", "Stay Curious."];
        const shopItems = [
            { id: 'pet_dog', name: 'Puppy', cost: 0, type: 'pet', char: 'üê∂' },
            { id: 'pet_cat', name: 'Kitty', cost: 500, type: 'pet', char: 'üê±' },
            { id: 'pet_fox', name: 'Fox', cost: 1000, type: 'pet', char: 'ü¶ä' },
            { id: 'pet_owl', name: 'Owl', cost: 1500, type: 'pet', char: 'ü¶â' }
        ];

        let timerInt;
        let saveTimeout;
        let timerDuration = 25;
        let running = false;

        function toggleAuthMode() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('register-form').classList.toggle('hidden');
            document.getElementById('auth-error').innerText = "";
        }

        window.init = function() {
            document.getElementById('daily-quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
            checkStreak();
            
            // Set Avatar
            const bg = window.state.theme === 'light' ? 'E5E7EB' : '374151';
            const nameParam = window.state.username || 'St';
            if(!window.state.avatar) document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${nameParam}&background=${bg}&color=9CA3AF`;
            else document.getElementById('user-avatar').src = window.state.avatar;
        }

        window.checkStreak = function() {
            const today = new Date().toDateString();
            if(window.state.lastLogin !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if(window.state.lastLogin === yesterday.toDateString()) window.state.streak++;
                else if (window.state.lastLogin) window.state.streak = 1; 
                window.state.lastLogin = today;
                window.saveData();
            }
        }

        window.showPage = function(id, btn) {
            document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(btn) {
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
            }
            const t = {'home':`Hello, ${window.state.username}`,'notes':'Notes','focus':'Focus Timer','shop':'Market','settings':'Settings'};
            document.getElementById('page-title').innerText = t[id] || t['home'];
        }

        window.updateUI = function() {
            // Update Name in Sidebar
            document.getElementById('sidebar-name').innerText = window.state.username;
            if(document.getElementById('page-title').innerText.includes('Hello')) {
                document.getElementById('page-title').innerText = `Hello, ${window.state.username}`;
            }

            document.getElementById('lvl-display').innerText = "LVL " + window.state.lvl;
            document.getElementById('xp-text').innerText = `${window.state.xp} / ${window.state.lvl * 500}`;
            document.getElementById('xp-bar').style.width = `${(window.state.xp / (window.state.lvl*500)) * 100}%`;
            document.getElementById('coin-display').innerText = window.state.coins;
            document.getElementById('streak-display').innerText = window.state.streak;
            
            const pet = shopItems.find(i => i.id === window.state.equippedPet) || shopItems[0];
            document.getElementById('pet-display').innerText = pet.char;
            
            document.getElementById('theme-btn').innerText = window.state.theme === 'light' ? "Switch to Dark Mode" : "Switch to Light Mode";
        }

        // TODO
        window.addTask = function() {
            const val = document.getElementById('todo-input').value;
            if(!val.trim()) return;
            if(!window.state.todos) window.state.todos = [];
            window.state.todos.push({ text: val, done: false });
            document.getElementById('todo-input').value = '';
            window.saveData(); window.renderTodos();
        }

        window.toggleTask = function(i) {
            window.state.todos[i].done = !window.state.todos[i].done;
            if(window.state.todos[i].done) {
                window.state.coins += 20;
                window.state.xp += 10;
                checkLvl();
            }
            window.saveData(); window.renderTodos(); window.updateUI();
        }

        window.deleteTask = function(i) {
            window.state.todos.splice(i, 1);
            window.saveData(); window.renderTodos();
        }

        window.renderTodos = function() {
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            if(!window.state.todos) return;
            window.state.todos.forEach((t, i) => {
                list.innerHTML += `
                <div class="todo-item ${t.done ? 'done' : ''}">
                    <div class="todo-check" onclick="toggleTask(${i})"><i class="fas fa-check"></i></div>
                    <span style="flex:1; cursor:pointer;" onclick="toggleTask(${i})">${t.text}</span>
                    <i class="fas fa-trash todo-del" onclick="deleteTask(${i})"></i>
                </div>`;
            });
        }

        // TIMER
        window.adjustTime = (v) => { if(!running) { timerDuration = Math.max(5, timerDuration + v); document.getElementById('timer-display').innerText = timerDuration + ":00"; }};
        window.toggleTimer = () => {
            const btn = document.getElementById('btn-toggle');
            if(running) { clearInterval(timerInt); running=false; btn.innerText="Start"; btn.className="btn btn-primary"; }
            else { running=true; btn.innerText="Pause"; btn.className="btn"; timerInt = setInterval(tick, 1000); }
        };
        function tick() {
            let [m, s] = document.getElementById('timer-display').innerText.split(':').map(Number);
            if(m===0 && s===0) {
                toggleTimer(); alert("Session Complete!");
                window.state.coins += 100; window.state.xp += 50; checkLvl();
                window.saveData(); window.updateUI();
                return;
            }
            if(s===0) { m--; s=59; } else s--;
            document.getElementById('timer-display').innerText = `${m}:${s<10?'0'+s:s}`;
        }
        function checkLvl() { if(window.state.xp >= window.state.lvl * 500) { window.state.lvl++; window.state.xp = 0; alert("Level Up!"); } }

        // SHOP
        window.renderShop = () => {
            const c = document.getElementById('shop-container'); c.innerHTML='';
            shopItems.forEach(i => {
                const owned = window.state.inventory.includes(i.id);
                const equipped = window.state.equippedPet === i.id;
                c.innerHTML += `
                <div class="shop-item ${equipped?'equipped':''}" onclick="buy('${i.id}', ${i.cost})">
                    <div style="font-size:2.5rem;">${i.char}</div>
                    <div style="font-weight:700; margin-top:5px;">${i.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">${owned ? (equipped?'Equipped':'Owned') : i.cost}</div>
                </div>`;
            });
        }
        window.buy = (id, cost) => {
            if(window.state.inventory.includes(id)) { window.state.equippedPet = id; }
            else if(window.state.coins >= cost) { window.state.coins -= cost; window.state.inventory.push(id); window.state.equippedPet = id; }
            window.saveData(); window.renderShop(); window.updateUI();
        }

        // SYSTEM
        window.handleNoteInput = () => {
            window.state.notes = document.getElementById('notepad').value;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(window.saveData, 1000);
        }
        window.exportNotes = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([document.getElementById('notepad').value], {type:'text/plain'}));
            a.download = 'notes.txt'; a.click();
        }
        window.toggleTheme = () => {
            window.state.theme = window.state.theme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', window.state.theme);
            const bg = window.state.theme === 'light' ? 'E5E7EB' : '374151';
            const nameParam = window.state.username || 'St';
            if(window.state.avatar.includes('ui-avatars')) {
                document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${nameParam}&background=${bg}&color=9CA3AF`;
            }
            window.saveData(); window.updateUI();
        }
        window.uploadAvatar = (inp) => {
            const r = new FileReader();
            r.onload = e => { window.state.avatar = e.target.result; document.getElementById('user-avatar').src=e.target.result; window.saveData(); };
            if(inp.files[0]) r.readAsDataURL(inp.files[0]);
        }
    </script>
</body>
</html>
