<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHall Focus v13</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #f8fafc;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --gold: #f59e0b;
            --danger: #ef4444;
            --success: #22c55e;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --sidebar-bg: #1e293b;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #818cf8;
            --border: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* Mood Themes */
        body.mood-sunset { --bg-color: #fff1f2; --accent: #e11d48; }
        body.mood-forest { --bg-color: #f0fdf4; --accent: #16a34a; }
        body.mood-midnight { --bg-color: #020617; --sidebar-bg: #0f172a; --card-bg: #0f172a; --text-primary: #f8fafc; --text-secondary: #94a3b8; --border: #1e293b; }

        * { box-sizing: border-box; transition: background 0.4s, color 0.3s; outline: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; }

        /* --- SIDEBAR --- */
        .sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem 1rem; z-index: 100; transition: margin 0.3s; }
        body.zen-mode .sidebar { margin-left: -280px; }
        .logo { font-weight: 700; font-size: 1.2rem; margin-bottom: 1.5rem; color: var(--accent); display: flex; align-items: center; gap: 10px; }
        
        /* Player Card */
        .player-card { background: var(--bg-color); border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; position: relative; }
        .avatar-frame { width: 80px; height: 80px; margin: 0 auto 10px; border-radius: 50%; background: var(--card-bg); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: var(--text-primary); border: 3px solid var(--border); }
        .fx-fire { box-shadow: 0 0 15px #ef4444; border-color: #ef4444; animation: pulse-red 2s infinite; }
        .fx-rainbow { border: 3px solid transparent; background-image: linear-gradient(white, white), linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet); background-origin: border-box; background-clip: content-box, border-box; animation: spin-border 4s linear infinite; }
        .fx-neon { box-shadow: 0 0 10px #22c55e, 0 0 20px #22c55e; border-color: #22c55e; }
        .fx-glitch { border-color: var(--text-primary); animation: glitch 1s infinite; }
        .fx-gold { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }
        .player-stats { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px; }
        .stat-badge { background: var(--card-bg); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border); font-weight: 600; }
        .xp-bar { width: 100%; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .xp-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s; }

        /* Navigation */
        .nav-btn { background: none; border: none; width: 100%; text-align: left; padding: 12px; margin-bottom: 5px; color: var(--text-secondary); border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: all 0.2s; }
        .nav-btn:hover { background: var(--bg-color); color: var(--accent); }
        .nav-btn.active { background: var(--bg-color); color: var(--accent); font-weight: 600; }
        .submenu { margin-left: 20px; border-left: 2px solid var(--border); overflow: hidden; max-height: 0; transition: max-height 0.3s ease; }
        .submenu.open { max-height: 300px; }
        .sub-btn { display: block; width: 100%; padding: 8px 12px; text-align: left; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem; }
        .sub-btn:hover { color: var(--accent); font-weight: 600; }

        /* --- TIMER UI --- */
        .timer-tabs { display: flex; background: var(--bg-color); border-radius: 8px; padding: 4px; margin-bottom: 20px; border: 1px solid var(--border); }
        .timer-tab { flex: 1; border: none; background: none; padding: 8px; cursor: pointer; border-radius: 6px; font-weight: 600; color: var(--text-secondary); font-size: 0.85rem; }
        .timer-tab.active { background: var(--card-bg); color: var(--accent); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .timer-controls { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0; }
        .time-adj-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-color); cursor: pointer; color: var(--text-secondary); }
        .time-adj-btn:hover { color: var(--accent); border-color: var(--accent); }

        /* --- SHOP UI --- */
        .shop-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .coin-display { background: var(--gold); color: white; padding: 5px 15px; border-radius: 20px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .shop-item { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; text-align: center; transition: transform 0.2s; cursor: pointer; position: relative; overflow: hidden; }
        .shop-item:hover { transform: translateY(-3px); border-color: var(--accent); }
        .shop-item.owned { border-color: var(--success); background: rgba(34, 197, 94, 0.05); }
        .shop-item.equipped { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent); }
        .item-icon { font-size: 2rem; margin-bottom: 10px; color: var(--text-primary); }
        .item-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; }
        .item-cost { font-size: 0.8rem; color: var(--gold); font-weight: 700; }
        .owned-badge { font-size: 0.7rem; color: var(--success); font-weight: 700; display: none; }
        .shop-item.owned .item-cost { display: none; }
        .shop-item.owned .owned-badge { display: block; }

        /* --- GENERAL UI --- */
        .main { flex: 1; padding: 2rem; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .card { background: var(--card-bg); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Floating Elements */
        #zen-exit-btn { position: fixed; bottom: 20px; left: 20px; z-index: 1000; background: var(--accent); color: white; padding: 10px 20px; border-radius: 30px; border: none; cursor: pointer; display: none; }
        body.zen-mode #zen-exit-btn { display: block; }
        #xp-toast { position: fixed; top: 20px; right: 20px; background: var(--gold); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transform: translateX(200%); transition: transform 0.3s; z-index: 2000; }
        #xp-toast.show { transform: translateX(0); }

        /* Animations */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes spin-border { 100% { transform: rotate(360deg); } }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }

        /* Common */
        textarea { width: 100%; height: 65vh; background: var(--bg-color); color: var(--text-primary); border: 1px solid var(--border); padding: 2rem; border-radius: 12px; resize: none; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        /* Radio */
        .radio-container { display: flex; flex-direction: column; align-items: center; }
        .record-player { width: 200px; height: 200px; background: #1e1e1e; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; border: 5px solid #2d2d2d; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .record-player.playing { animation: spin 4s linear infinite; }
        .record-label { width: 80px; height: 80px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; }
        .record-label i { color: white; font-size: 1.5rem; }
        .station-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 20px; width: 100%; }
        .station-btn { background: var(--bg-color); border: 1px solid var(--border); padding: 15px; border-radius: 12px; cursor: pointer; text-align: center; }
        .station-btn.active { background: var(--accent); color: white; }

        /* Calc */
        #calcDisplay { width: 100%; padding: 15px; font-size: 1.8rem; text-align: right; background: var(--bg-color); border: 1px solid var(--border); color: var(--text-primary); border-radius: 10px; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .calc-btn { padding: 15px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; background: var(--bg-color); color: var(--text-primary); box-shadow: 0 2px 0 var(--border); }
        .calc-btn.accent { background: var(--accent); color: white; }
    </style>
</head>
<body data-theme="light">

    <nav class="sidebar">
        <div class="logo"><i class="fas fa-brain"></i> StudyHall</div>
        
        <div class="player-card">
            <div class="avatar-frame" id="sidebar-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div style="font-weight: 700; font-size: 1rem;">Student</div>
            <div class="player-stats">
                <span class="stat-badge" id="player-level">Lvl 1</span>
                <span class="stat-badge" style="color:var(--gold);"><i class="fas fa-coins"></i> <span id="coin-balance">0</span></span>
            </div>
            <div class="xp-bar"><div class="xp-fill" id="xp-fill"></div></div>
        </div>

        <button class="nav-btn active" onclick="showSection('dashboard', this)"><i class="fas fa-columns"></i> Dashboard</button>
        <button class="nav-btn" onclick="toggleNotebookMenu(this)">
            <i class="fas fa-sticky-note"></i> Notebook <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 0.8rem;"></i>
        </button>
        <div id="notebook-submenu" class="submenu"></div>
        <button class="nav-btn" onclick="showSection('shop', this)"><i class="fas fa-store"></i> Avatar Shop</button>
        <button class="nav-btn" onclick="showSection('radio-room', this)"><i class="fas fa-music"></i> Radio Room</button>
        <button class="nav-btn" onclick="showSection('todos', this)"><i class="fas fa-check-circle"></i> Tasks</button>
        <button class="nav-btn" onclick="showSection('calculator', this)"><i class="fas fa-calculator"></i> Calculator</button>

        <div style="flex-grow: 1;"></div>
        <button class="nav-btn" onclick="showSection('settings', this)"><i class="fas fa-cog"></i> Settings</button>
        <button class="nav-btn" onclick="toggleZenMode()"><i class="fas fa-expand-arrows-alt"></i> Zen Mode</button>
    </nav>

    <button id="zen-exit-btn" onclick="toggleZenMode()"><i class="fas fa-compress-arrows-alt"></i> Exit</button>
    <div id="xp-toast"><i class="fas fa-star"></i> +100 XP</div>

    <main class="main">
        <div class="header">
            <div>
                <h2 id="page-title" style="margin:0;">Dashboard</h2>
                <div id="status-bar" style="font-size:0.8rem; color:var(--text-secondary); margin-top:5px;"><i class="fas fa-cloud"></i> Ready</div>
            </div>
            <div style="text-align:right;">
                <h3 id="clock" style="margin:0; font-family:monospace; color:var(--accent);">00:00</h3>
                <div id="now-playing-pill" style="font-size: 0.8rem; color: var(--accent); opacity: 0;">
                    <i class="fas fa-volume-up"></i> Audio Active
                </div>
            </div>
        </div>

        <div id="dashboard" class="section active">
            <div class="dashboard-grid">
                <div class="card" style="text-align:center;">
                    <div class="timer-tabs">
                        <button class="timer-tab active" id="tab-timer" onclick="setTimerMode('timer')">Timer</button>
                        <button class="timer-tab" id="tab-stopwatch" onclick="setTimerMode('stopwatch')">Stopwatch</button>
                    </div>
                    
                    <div class="timer-controls" id="timer-adj-controls">
                        <button class="time-adj-btn" onclick="adjustTimer(-5)"><i class="fas fa-minus"></i></button>
                        <span style="font-size:0.9rem; color:var(--text-secondary);">Set Duration</span>
                        <button class="time-adj-btn" onclick="adjustTimer(5)"><i class="fas fa-plus"></i></button>
                    </div>

                    <div style="font-size: 3.5rem; font-weight: 700; margin: 10px 0; font-family: monospace;" id="timer-display">25:00</div>
                    
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button class="btn btn-primary" onclick="toggleTimer()" id="timer-btn">Start</button>
                        <button class="btn" id="reset-btn" onclick="resetTimer()">Reset</button>
                    </div>
                    <p id="timer-reward-msg" style="font-size:0.8rem; color:var(--text-secondary); margin-top:15px;">Reward: 500 XP & Coins</p>
                </div>

                <div class="card">
                    <h3 style="margin-top:0;"><i class="fas fa-tasks"></i> Top Tasks</h3>
                    <ul id="dashboard-todo-list" style="padding-left: 20px; color: var(--text-secondary);"><li>No tasks yet.</li></ul>
                </div>
                <div class="card">
                    <h3 style="margin-top:0;"><i class="fas fa-calendar-alt"></i> Schedule</h3>
                    <div id="schedule-list"></div>
                </div>
            </div>
        </div>

        <div id="shop" class="section">
            <div class="shop-header">
                <h2>Avatar Marketplace</h2>
                <div class="coin-display"><i class="fas fa-coins"></i> <span id="shop-balance">0</span></div>
            </div>
            <h3 style="margin-bottom:15px; color:var(--text-secondary);">Characters</h3>
            <div class="shop-grid" id="shop-avatars"></div>
            <h3 style="margin:30px 0 15px; color:var(--text-secondary);">Profile Effects</h3>
            <div class="shop-grid" id="shop-effects"></div>
        </div>

        <div id="radio-room" class="section">
            <div class="card" style="max-width: 600px; margin: 0 auto; text-align: center;">
                <h3><i class="fas fa-broadcast-tower"></i> Radio Room</h3>
                <div class="radio-container">
                    <div class="record-player" id="record-player">
                        <div class="record-grooves"></div>
                        <div class="record-label"><i class="fas fa-music"></i></div>
                    </div>
                </div>
                <div style="margin: 30px 0 20px;">
                    <button id="main-play-btn" class="btn btn-primary" style="width: 150px; border-radius: 30px; padding: 12px;" onclick="toggleAudio()"><i class="fas fa-play"></i> Start</button>
                    <div style="margin-top: 15px;"><input type="range" min="0" max="1" step="0.05" value="0.4" oninput="setVolume(this.value)" style="width: 200px; accent-color: var(--accent);"></div>
                </div>
                <div class="station-grid">
                    <div class="station-btn active" id="st-lofi" onclick="changeStation('lofi')"><i class="fas fa-coffee"></i> Lofi Girl</div>
                    <div class="station-btn" id="st-piano" onclick="changeStation('piano')"><i class="fas fa-book-open"></i> Piano</div>
                    <div class="station-btn" id="st-rain" onclick="changeStation('rain')"><i class="fas fa-cloud-rain"></i> Rain</div>
                    <div class="station-btn" id="st-noise" onclick="changeStation('noise')"><i class="fas fa-wind"></i> Noise</div>
                </div>
            </div>
        </div>

        <div id="notebook-view" class="section">
            <textarea id="current-note" oninput="handleNoteInput()" placeholder="Start typing..."></textarea>
        </div>
        <div id="todos" class="section">
            <div class="card" style="max-width: 600px; margin: 0 auto;">
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="text" id="newTodo" placeholder="New Task..." style="flex:1; padding:12px; border-radius:8px; border:1px solid var(--border);">
                    <button class="btn btn-primary" onclick="addTodo()">Add</button>
                </div>
                <div id="todoList"></div>
            </div>
        </div>
        <div id="calculator" class="section">
            <div class="card" style="max-width:350px; margin:0 auto;">
                <input type="text" id="calcDisplay" readonly>
                <div class="calc-grid">
                    <button class="calc-btn" onclick="calc('7')">7</button><button class="calc-btn" onclick="calc('8')">8</button><button class="calc-btn" onclick="calc('9')">9</button><button class="calc-btn accent" onclick="calc('/')">√∑</button>
                    <button class="calc-btn" onclick="calc('4')">4</button><button class="calc-btn" onclick="calc('5')">5</button><button class="calc-btn" onclick="calc('6')">6</button><button class="calc-btn accent" onclick="calc('*')">√ó</button>
                    <button class="calc-btn" onclick="calc('1')">1</button><button class="calc-btn" onclick="calc('2')">2</button><button class="calc-btn" onclick="calc('3')">3</button><button class="calc-btn accent" onclick="calc('-')">-</button>
                    <button class="calc-btn" onclick="calc('C')">C</button><button class="calc-btn" onclick="calc('0')">0</button><button class="calc-btn" onclick="calc('=')">=</button><button class="calc-btn accent" onclick="calc('+')">+</button>
                </div>
            </div>
        </div>
        <div id="settings" class="section">
            <div class="card" style="max-width: 500px; margin: 0 auto;">
                <h3>Preferences</h3>
                <div class="setting-row"><span>Theme</span><button class="btn" onclick="toggleTheme()">Toggle Dark</button></div>
                <div style="margin-top:20px;"><p>Recover ID:</p><input type="text" id="user-id-display" style="width:100%; padding:10px;"></div>
                <div style="margin-top:20px;"><button class="btn btn-danger" onclick="clearData()">Reset Data</button></div>
            </div>
        </div>
    </main>

    <audio id="audio-engine" loop preload="none" crossorigin="anonymous"></audio>

    <script>
        // --- CONFIG ---
        const firebaseConfig = { apiKey: "PASTE_KEY_HERE" };
        let db, userId;
        try { if(typeof firebase!=='undefined' && firebaseConfig.apiKey.length > 20) { firebase.initializeApp(firebaseConfig); db=firebase.database(); } } catch(e){}

        // --- STATE ---
        const appState = {
            theme: localStorage.getItem('theme') || 'light',
            mood: localStorage.getItem('mood') || '',
            isPlaying: false,
            currentStation: 'lofi',
            activeNoteId: null,
            // Timer State
            timerMode: 'timer', // 'timer' or 'stopwatch'
            timerDuration: 25,
            stopwatchSeconds: 0,
            // RPG State
            xp: parseInt(localStorage.getItem('study_xp')) || 0,
            level: parseInt(localStorage.getItem('study_level')) || 1,
            coins: parseInt(localStorage.getItem('study_coins')) || 0,
            inventory: JSON.parse(localStorage.getItem('study_inventory')) || ['av_default'],
            equippedAvatar: localStorage.getItem('study_eq_avatar') || 'av_default',
            equippedEffect: localStorage.getItem('study_eq_effect') || ''
        };

        const shopItems = [
            { id: 'av_default', type: 'avatar', name: 'Student', cost: 0, icon: 'fa-user' },
            { id: 'av_robot', type: 'avatar', name: 'Droid', cost: 500, icon: 'fa-robot' },
            { id: 'av_wiz', type: 'avatar', name: 'Wizard', cost: 1000, icon: 'fa-hat-wizard' },
            { id: 'av_cat', type: 'avatar', name: 'Hacker Cat', cost: 1500, icon: 'fa-cat' },
            { id: 'av_astro', type: 'avatar', name: 'Astronaut', cost: 2000, icon: 'fa-user-astronaut' },
            { id: 'av_dragon', type: 'avatar', name: 'Dragon', cost: 5000, icon: 'fa-dragon' },
            { id: 'fx_gold', type: 'effect', name: 'Gold Border', cost: 1000, class: 'fx-gold' },
            { id: 'fx_fire', type: 'effect', name: 'Fire Aura', cost: 2500, class: 'fx-fire' },
            { id: 'fx_neon', type: 'effect', name: 'Neon Glow', cost: 3000, class: 'fx-neon' },
            { id: 'fx_glitch', type: 'effect', name: 'Glitch', cost: 4000, class: 'fx-glitch' },
            { id: 'fx_rainbow', type: 'effect', name: 'Rainbow', cost: 5000, class: 'fx-rainbow' }
        ];

        const stations = {
            lofi: "https://fastly.jsdelivr.net/gh/sasi-k/lofi-player/public/music/1.mp3",
            piano: "https://fastly.jsdelivr.net/gh/josephernest/BigSound/master/examples/mp3/02.mp3",
            rain: "generate:rain",
            noise: "generate:brown"
        };
        let audioCtx, jsNode, audioNode, saveTimeout, tmr;

        // --- INIT ---
        function init() {
            if(appState.theme==='dark') document.body.setAttribute('data-theme', 'dark');
            userId = localStorage.getItem('study_user_id') || 'u_'+Math.random().toString(36).substr(2,9);
            localStorage.setItem('study_user_id', userId);
            
            const idInput = document.getElementById('user-id-display');
            if(idInput) {
                idInput.value = userId;
                idInput.addEventListener('change', e => {
                    if(confirm("Switch ID?")) { localStorage.setItem('study_user_id', e.target.value); location.reload(); }
                });
            }

            document.addEventListener('keydown', e => { if(e.key==='Escape') document.body.classList.remove('zen-mode'); });
            setInterval(()=> { document.getElementById('clock').innerText = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }, 1000);

            loadSchedule(); loadTodos(); renderNotebookMenu(); updateProfileUI(); renderShop(); updateTimerDisplay();

            const ae = document.getElementById('audio-engine');
            if(ae) ae.onerror = () => { setTimeout(()=>changeStation('noise'),2000); };
        }

        // --- TIMER & STOPWATCH LOGIC ---
        function setTimerMode(mode) {
            appState.timerMode = mode;
            clearInterval(tmr); tmr = null;
            document.getElementById('timer-btn').innerText = "Start";
            
            // Toggle Tab Styles
            document.getElementById('tab-timer').className = mode === 'timer' ? 'timer-tab active' : 'timer-tab';
            document.getElementById('tab-stopwatch').className = mode === 'stopwatch' ? 'timer-tab active' : 'timer-tab';
            
            // Toggle Controls
            document.getElementById('timer-adj-controls').style.display = mode === 'timer' ? 'flex' : 'none';
            document.getElementById('reset-btn').innerText = mode === 'timer' ? 'Reset' : 'Finish';
            
            // Update Reward Text
            const msg = mode === 'timer' 
                ? `Reward: ${appState.timerDuration * 20} XP & Coins`
                : `Reward: 20 XP per minute`;
            document.getElementById('timer-reward-msg').innerText = msg;

            updateTimerDisplay();
        }

        function adjustTimer(mins) {
            if(appState.timerMode !== 'timer') return;
            appState.timerDuration += mins;
            if(appState.timerDuration < 5) appState.timerDuration = 5;
            if(appState.timerDuration > 120) appState.timerDuration = 120;
            updateTimerDisplay();
            document.getElementById('timer-reward-msg').innerText = `Reward: ${appState.timerDuration * 20} XP & Coins`;
        }

        function toggleTimer() {
            const btn = document.getElementById('timer-btn');
            
            if(tmr) {
                // Pause
                clearInterval(tmr); tmr = null;
                btn.innerText = "Resume";
            } else {
                // Start
                btn.innerText = "Pause";
                tmr = setInterval(tick, 1000);
            }
        }

        function tick() {
            const display = document.getElementById('timer-display');
            
            if(appState.timerMode === 'timer') {
                // COUNTDOWN
                let [m, s] = display.innerText.split(':').map(Number);
                if(s === 0) {
                    if(m === 0) {
                        clearInterval(tmr); tmr = null;
                        document.getElementById('timer-btn').innerText = "Start";
                        const reward = appState.timerDuration * 20;
                        alert(`Time's up! You earned ${reward} XP & Coins!`);
                        addRewards(reward, reward);
                        return;
                    }
                    m--; s = 59;
                } else s--;
                display.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            
            } else {
                // STOPWATCH (Count Up)
                appState.stopwatchSeconds++;
                let m = Math.floor(appState.stopwatchSeconds / 60);
                let s = appState.stopwatchSeconds % 60;
                display.innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            }
        }

        function resetTimer() {
            clearInterval(tmr); tmr = null;
            document.getElementById('timer-btn').innerText = "Start";
            
            if(appState.timerMode === 'timer') {
                updateTimerDisplay();
            } else {
                // STOPWATCH FINISH LOGIC
                if(appState.stopwatchSeconds > 60) {
                    const mins = Math.floor(appState.stopwatchSeconds / 60);
                    const reward = mins * 20;
                    alert(`Session Complete! Studied for ${mins} mins.\nEarned ${reward} XP & Coins.`);
                    addRewards(reward, reward);
                }
                appState.stopwatchSeconds = 0;
                document.getElementById('timer-display').innerText = "00:00";
            }
        }

        function updateTimerDisplay() {
            if(appState.timerMode === 'timer') {
                document.getElementById('timer-display').innerText = `${appState.timerDuration}:00`;
            } else {
                document.getElementById('timer-display').innerText = "00:00";
            }
        }

        // --- RPG & SHOP ---
        function addRewards(xpAmt, coinAmt) {
            appState.xp += xpAmt;
            appState.coins += coinAmt;
            const nextLvl = appState.level * 1000;
            if(appState.xp >= nextLvl) { appState.level++; alert("üéâ Level Up! You are now Level " + appState.level); }
            saveRPG(); updateProfileUI(); renderShop();
            const t = document.getElementById('xp-toast'); t.innerHTML = `<i class="fas fa-coins"></i> +${coinAmt} Coins`; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000);
        }
        function saveRPG() {
            localStorage.setItem('study_xp', appState.xp);
            localStorage.setItem('study_level', appState.level);
            localStorage.setItem('study_coins', appState.coins);
            localStorage.setItem('study_inventory', JSON.stringify(appState.inventory));
            localStorage.setItem('study_eq_avatar', appState.equippedAvatar);
            localStorage.setItem('study_eq_effect', appState.equippedEffect);
        }
        function updateProfileUI() {
            document.getElementById('player-level').innerText = "Lvl " + appState.level;
            document.getElementById('coin-balance').innerText = appState.coins;
            document.getElementById('shop-balance').innerText = appState.coins;
            const next = appState.level * 1000;
            const prev = (appState.level-1) * 1000;
            const pct = ((appState.xp - prev) / (next - prev)) * 100;
            document.getElementById('xp-fill').style.width = pct + "%";
            
            const avItem = shopItems.find(i => i.id === appState.equippedAvatar) || shopItems[0];
            const fxItem = shopItems.find(i => i.id === appState.equippedEffect);
            const frame = document.getElementById('sidebar-avatar');
            frame.innerHTML = `<i class="fas ${avItem.icon}"></i>`;
            frame.className = 'avatar-frame ' + (fxItem ? fxItem.class : '');
        }
        function renderShop() {
            const avGrid = document.getElementById('shop-avatars');
            const fxGrid = document.getElementById('shop-effects');
            avGrid.innerHTML = ''; fxGrid.innerHTML = '';
            shopItems.forEach(item => {
                const owned = appState.inventory.includes(item.id);
                const equipped = (item.type === 'avatar' && appState.equippedAvatar === item.id) || (item.type === 'effect' && appState.equippedEffect === item.id);
                const div = document.createElement('div');
                div.className = `shop-item ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''}`;
                div.onclick = () => handleShopClick(item);
                div.innerHTML = `<div class="item-icon ${item.class || ''}"><i class="fas ${item.icon || 'fa-star'}"></i></div><div class="item-name">${item.name}</div><div class="item-cost"><i class="fas fa-coins"></i> ${item.cost}</div><div class="owned-badge">${equipped ? 'EQUIPPED' : 'OWNED'}</div>`;
                if(item.type === 'avatar') avGrid.appendChild(div); else fxGrid.appendChild(div);
            });
        }
        function handleShopClick(item) {
            if(appState.inventory.includes(item.id)) {
                if(item.type === 'avatar') appState.equippedAvatar = item.id;
                else { if(appState.equippedEffect === item.id) appState.equippedEffect = ''; else appState.equippedEffect = item.id; }
                saveRPG(); updateProfileUI(); renderShop();
            } else {
                if(appState.coins >= item.cost) {
                    if(confirm(`Buy ${item.name}?`)) {
                        appState.coins -= item.cost; appState.inventory.push(item.id);
                        saveRPG(); updateProfileUI(); renderShop();
                    }
                } else alert("Not enough coins!");
            }
        }

        // --- AUDIO, DATA, ETC ---
        function changeStation(id) {
            document.querySelectorAll('.station-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('st-'+id).classList.add('active');
            appState.currentStation = id;
            if(appState.isPlaying) playAudioSource();
        }
        function toggleAudio() {
            const btn = document.getElementById('main-play-btn');
            const ae = document.getElementById('audio-engine');
            if(appState.isPlaying) {
                ae.pause(); stopGen(); appState.isPlaying=false;
                btn.innerHTML = '<i class="fas fa-play"></i> Start';
                document.getElementById('record-player').classList.remove('playing');
                document.getElementById('now-playing-pill').style.opacity = '0';
            } else {
                playAudioSource(); appState.isPlaying=true;
                btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                document.getElementById('record-player').classList.add('playing');
                document.getElementById('now-playing-pill').style.opacity = '1';
            }
        }
        function playAudioSource() {
            const ae = document.getElementById('audio-engine');
            ae.pause(); stopGen();
            const src = stations[appState.currentStation];
            if(src.startsWith("generate:")) {
                startGen(src.split(':')[1]);
                document.getElementById('stream-status').innerText = "‚ö° Generating (Local)";
            } else {
                document.getElementById('stream-status').innerText = "‚åõ Buffering...";
                ae.src = src; ae.volume = document.querySelector('input[type=range]').value;
                ae.play().then(()=> document.getElementById('stream-status').innerText = "‚úÖ Playing").catch(()=> document.getElementById('stream-status').innerText = "‚ö†Ô∏è Blocked");
            }
        }
        function setVolume(v) { const ae=document.getElementById('audio-engine'); if(ae) ae.volume=v; if(jsNode) jsNode.gain.value = v*0.15; }
        function startGen(type) {
            if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            const buf = audioCtx.createBuffer(1, audioCtx.sampleRate*2, audioCtx.sampleRate);
            const d = buf.getChannelData(0);
            for(let i=0; i<d.length; i++) {
                const w = Math.random()*2-1;
                if(type==='brown') { d[i] = ( (d[i-1]||0) + (0.02*w) ) / 1.02; d[i]*=3.5; }
                else d[i] = (Math.random()*2-1)*0.1;
            }
            audioNode = audioCtx.createBufferSource(); audioNode.buffer=buf; audioNode.loop=true;
            jsNode = audioCtx.createGain(); jsNode.gain.value=0.1;
            audioNode.connect(jsNode); jsNode.connect(audioCtx.destination); audioNode.start();
        }
        function stopGen() { if(audioNode) { audioNode.stop(); audioNode=null; } }
        function showSection(id, btn) {
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(btn) {
                document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('page-title').innerText = btn.innerText.trim();
            }
        }
        function toggleZenMode() { document.body.classList.toggle('zen-mode'); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')==='light'?'dark':'light'); }
        function loadSchedule() { 
            const s = JSON.parse(localStorage.getItem('study_schedule')) || [{class:'Math'},{class:'History'},{class:'Science'},{class:'English'},{class:'Elective'}];
            const c = document.getElementById('schedule-list'); c.innerHTML='';
            s.forEach((it,i) => {
                const d=document.createElement('div'); d.className='schedule-item';
                d.innerHTML=`<div style="font-weight:600;color:var(--accent);">P${i+1}</div><input value="${it.class}" onchange="saveSched(${i},this.value)">`;
                c.appendChild(d);
            });
        }
        window.saveSched = (i,v) => {
            const s = JSON.parse(localStorage.getItem('study_schedule')) || [{class:'Math'},{class:'History'},{class:'Science'},{class:'English'},{class:'Elective'}];
            s[i].class = v; localStorage.setItem('study_schedule', JSON.stringify(s));
            renderNotebookMenu();
        };
        function renderNotebookMenu() {
            const s = JSON.parse(localStorage.getItem('study_schedule'));
            const m = document.getElementById('notebook-submenu'); m.innerHTML='';
            if(s) s.forEach((it,i) => {
                const b = document.createElement('button'); b.className='sub-btn';
                b.innerHTML=`<i class="fas fa-circle" style="font-size:0.5rem;margin-right:8px;"></i> ${it.class}`;
                b.onclick=()=>openNote('p'+i, it.class, b); m.appendChild(b);
            });
        }
        window.toggleNotebookMenu = (b) => { const m=document.getElementById('notebook-submenu'); m.classList.toggle('open'); };
        function openNote(id, title, btn) {
            document.querySelectorAll('.sub-btn').forEach(b=>b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            showSection('notebook-view'); document.getElementById('page-title').innerText=title;
            appState.activeNoteId=id; document.getElementById('current-note').value=localStorage.getItem('note_'+id)||'';
        }
        window.handleNoteInput = () => {
            localStorage.setItem('note_'+appState.activeNoteId, document.getElementById('current-note').value);
            clearTimeout(saveTimeout); saveTimeout=setTimeout(()=>saveToCloud(),1000);
        };
        function saveToCloud() { if(db && userId) db.ref('users/'+userId+'/notes/'+appState.activeNoteId).set(localStorage.getItem('note_'+appState.activeNoteId)); }
        function addTodo() {
            const t = document.getElementById('newTodo'); if(!t.value)return;
            const l = JSON.parse(localStorage.getItem('study_todos')||'[]');
            l.push(t.value); localStorage.setItem('study_todos',JSON.stringify(l));
            t.value=''; loadTodos();
        }
        function loadTodos() {
            const l = JSON.parse(localStorage.getItem('study_todos')||'[]');
            const el = document.getElementById('todoList'); el.innerHTML='';
            const dash = document.getElementById('dashboard-todo-list'); dash.innerHTML='';
            if(l.length===0) dash.innerHTML='<li>No tasks.</li>';
            l.forEach((txt,i) => {
                const d=document.createElement('div'); d.style.cssText="padding:10px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;";
                d.innerHTML=`<span>${txt}</span> <button class="btn btn-danger" onclick="remTodo(${i})" style="font-size:0.8rem;padding:2px 8px;">Done</button>`;
                el.appendChild(d);
                if(i<3) dash.innerHTML+=`<li>${txt}</li>`;
            });
        }
        window.remTodo = (i) => {
            const l = JSON.parse(localStorage.getItem('study_todos')||'[]');
            l.splice(i,1); localStorage.setItem('study_todos',JSON.stringify(l));
            loadTodos(); addRewards(100, 100);
        };
        function calc(v) { const d=document.getElementById('calcDisplay'); if(v==='C')d.value=''; else if(v==='=')try{d.value=eval(d.value)}catch{} else d.value+=v; }
        function clearData() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }

        window.onload = init;
    </script>
</body>
</html>
