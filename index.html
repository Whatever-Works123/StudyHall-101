<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHall Dashboard</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* --- CSS VARIABLES & THEMES --- */
        :root {
            --bg-color: #f4f4f9;
            --sidebar-bg: #ffffff;
            --text-primary: #333333;
            --card-bg: #ffffff;
            --accent: #4a90e2; /* School Blue */
            --border: #ddd;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --text-primary: #e0e0e0;
            --card-bg: #2c2c2c;
            --accent: #bb86fc; /* Purple */
            --border: #444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

        body { display: flex; height: 100vh; background-color: var(--bg-color); color: var(--text-primary); transition: background 0.3s; }

        /* --- LOGIN MODAL --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .login-box {
            background: white; padding: 40px; border-radius: 10px; text-align: center; width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .login-box h2 { color: #333; margin-bottom: 20px; }
        .login-box input {
            width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;
        }
        .login-box button {
            width: 100%; padding: 12px; background: #4a90e2; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        .login-box p { color: red; margin-top: 10px; font-size: 0.9rem; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px;
            transition: background 0.3s;
        }

        .logo { font-size: 1.5rem; font-weight: bold; margin-bottom: 30px; color: var(--accent); }
        .user-info { font-size: 0.8rem; margin-bottom: 20px; color: grey; word-break: break-all; }

        .nav-btn {
            background: none; border: none;
            color: var(--text-primary);
            padding: 12px; text-align: left;
            cursor: pointer; border-radius: 8px;
            margin-bottom: 5px; font-size: 1rem;
            opacity: 0.7; transition: 0.2s;
            width: 100%; display: flex; align-items: center; gap: 10px;
        }
        .nav-btn:hover { opacity: 1; background-color: rgba(0,0,0,0.05); }
        .nav-btn.active { opacity: 1; background-color: var(--accent); color: white; }

        /* Mode Visibility */
        .school-only, .fun-only { display: none; }
        body.mode-school .school-only { display: block; }
        body.mode-fun .fun-only { display: block; }

        .settings-area { margin-top: auto; border-top: 1px solid var(--border); padding-top: 20px; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin-bottom: 20px; border-bottom: 2px solid var(--accent); padding-bottom: 10px; display: inline-block; }

        /* --- TOOLS --- */
        .todo-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .todo-input-group input { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 5px; background: var(--card-bg); color: var(--text-primary); }
        .todo-list { list-style: none; }
        .todo-item { 
            background: var(--card-bg); padding: 10px; margin-bottom: 5px; 
            border: 1px solid var(--border); border-radius: 5px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .delete-btn { color: #ff4444; cursor: pointer; font-weight: bold; padding: 0 10px; }

        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 300px; }
        .calc-btn { 
            padding: 20px; font-size: 1.2rem; cursor: pointer; 
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 5px;
            color: var(--text-primary);
        }
        .calc-display { 
            grid-column: span 4; padding: 15px; text-align: right; font-size: 1.5rem; 
            background: var(--card-bg); border: 1px solid var(--border); margin-bottom: 10px; 
            color: var(--text-primary);
        }

        textarea.notes-area {
            width: 100%; height: 300px; padding: 15px;
            background: var(--card-bg); color: var(--text-primary);
            border: 1px solid var(--border); border-radius: 10px; resize: vertical; font-family: monospace;
        }

        /* --- PERIODIC TABLE --- */
        .pt-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 5px; }
        .element { 
            border: 1px solid var(--border); padding: 5px; text-align: center; 
            background: var(--card-bg); border-radius: 5px; cursor: pointer;
        }
        .element strong { display: block; font-size: 1.2rem; color: var(--accent); }

        iframe { width: 100%; height: 600px; border: none; border-radius: 10px; background: white; }

        /* --- FULLSCREEN CHATTERBOX --- */
        .fullscreen-active {
            position: fixed !important; top: 0; left: 0;
            width: 100vw !important; height: 100vh !important;
            z-index: 2000; background: var(--bg-color);
            padding: 0 !important; display: flex; flex-direction: column;
        }
        .fullscreen-active iframe { flex: 1; border-radius: 0; height: 100%; }
        .fullscreen-active h2, .fullscreen-active p { display: none; }
        .fs-btn {
            background: var(--accent); color: white; border: none; 
            padding: 5px 15px; border-radius: 5px; cursor: pointer; 
            margin-left: 10px; font-size: 0.9rem;
        }
        
        /* Save Status Indicator */
        #save-status { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    </style>
</head>
<body class="mode-school" data-theme="light">

    <div id="login-overlay">
        <div class="login-box">
            <h2>üìö StudyHall Login</h2>
            <p style="color:#666; margin-bottom:15px;">Use your ChatterBox Account</p>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="loginUser()">Login</button>
            <p id="login-error"></p>
        </div>
    </div>

    <div id="save-status">All changes saved</div>

    <nav class="sidebar">
        <div class="logo">üìö StudyHall</div>
        <div class="user-info" id="user-display">Waiting for login...</div>
        
        <button class="nav-btn school-only active" onclick="showSection('school-home')">üè† Home</button>
        <button class="nav-btn school-only" onclick="showSection('todo')">‚úÖ To-Do List</button>
        <button class="nav-btn school-only" onclick="showSection('math')">üìê Math</button>
        <button class="nav-btn school-only" onclick="showSection('science')">üß¨ Science</button>
        <button class="nav-btn school-only" onclick="showSection('ela')">üìñ ELA</button>
        <button class="nav-btn school-only" onclick="showSection('history')">üìú History</button>

        <button class="nav-btn fun-only" onclick="showSection('fun-home')">üéÆ Fun Home</button>
        <button class="nav-btn fun-only" onclick="showSection('games')">üïπÔ∏è Games</button>
        <button class="nav-btn fun-only" onclick="showSection('chatterbox')">üí¨ ChatterBox</button>
        <button class="nav-btn fun-only" onclick="showSection('socials')">üì± Socials</button>

        <div class="settings-area">
            <button class="nav-btn" onclick="showSection('settings')">‚öôÔ∏è Settings</button>
            <button class="nav-btn" onclick="logoutUser()" style="color:#ff6b6b; margin-top:10px;">üö™ Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <div id="school-home" class="section active">
            <h2>Welcome Back.</h2>
            <p>Select a subject to retrieve your cloud notes.</p>
        </div>

        <div id="todo" class="section">
            <h2>Assignment Tracker</h2>
            <div class="todo-input-group">
                <input type="text" id="newTodo" placeholder="Add assignment...">
                <button onclick="addTodo()" style="padding:0 20px; background:var(--accent); color:white; border:none; border-radius:5px; cursor:pointer;">Add</button>
            </div>
            <ul id="todoList" class="todo-list"></ul>
        </div>

        <div id="math" class="section">
            <h2>Mathematics</h2>
            <div style="display:flex; gap: 20px; flex-wrap:wrap;">
                <div style="flex:1;">
                    <h3>Notes</h3>
                    <textarea id="note-math" class="notes-area" oninput="saveData('math')" placeholder="Type math formulas here..."></textarea>
                </div>
                <div>
                    <h3>Calculator</h3>
                    <input type="text" id="calcDisplay" class="calc-display" readonly>
                    <div class="calc-grid">
                        <button class="calc-btn" onclick="calc('7')">7</button>
                        <button class="calc-btn" onclick="calc('8')">8</button>
                        <button class="calc-btn" onclick="calc('9')">9</button>
                        <button class="calc-btn" onclick="calc('/')">/</button>
                        <button class="calc-btn" onclick="calc('4')">4</button>
                        <button class="calc-btn" onclick="calc('5')">5</button>
                        <button class="calc-btn" onclick="calc('6')">6</button>
                        <button class="calc-btn" onclick="calc('*')">*</button>
                        <button class="calc-btn" onclick="calc('1')">1</button>
                        <button class="calc-btn" onclick="calc('2')">2</button>
                        <button class="calc-btn" onclick="calc('3')">3</button>
                        <button class="calc-btn" onclick="calc('-')">-</button>
                        <button class="calc-btn" onclick="calc('0')">0</button>
                        <button class="calc-btn" onclick="calc('.')">.</button>
                        <button class="calc-btn" onclick="calc('=')">=</button>
                        <button class="calc-btn" onclick="calc('C')" style="background:#ffcccc; color:black;">C</button>
                        <button class="calc-btn" onclick="calc('+')">+</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="science" class="section">
            <h2>Science</h2>
            <h3>Lab Notes</h3>
            <textarea id="note-science" class="notes-area" oninput="saveData('science')" placeholder="Type hypothesis here..."></textarea>
            <br><br>
            <h3>Reference Table</h3>
            <div class="pt-container">
                <div class="element"><strong>H</strong><small>1</small></div>
                <div class="element"><strong>He</strong><small>2</small></div>
                <div class="element"><strong>Li</strong><small>3</small></div>
                <div class="element"><strong>Be</strong><small>4</small></div>
                <div class="element"><strong>B</strong><small>5</small></div>
                <div class="element"><strong>C</strong><small>6</small></div>
                <div class="element"><strong>N</strong><small>7</small></div>
                <div class="element"><strong>O</strong><small>8</small></div>
            </div>
        </div>

        <div id="ela" class="section">
            <h2>English Language Arts</h2>
            <textarea id="note-ela" class="notes-area" oninput="saveData('ela')" placeholder="Essay draft..."></textarea>
        </div>

        <div id="history" class="section">
            <h2>History</h2>
            <textarea id="note-history" class="notes-area" oninput="saveData('history')" placeholder="Timeline notes..."></textarea>
        </div>

        <div id="fun-home" class="section">
            <h2>Secret Lounge</h2>
            <p>Welcome to the unlocked section.</p>
        </div>

        <div id="games" class="section">
            <h2>Games Library</h2>
            <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:20px; margin-top:20px;">
                <div style="background:var(--card-bg); padding:20px; border-radius:10px; border:1px solid var(--border);">
                    <h3>Bing Games</h3>
                    <button onclick="document.getElementById('game-frame').src='https://www.bing.com/fun'" style="margin-top:10px; padding:5px 15px;">Load</button>
                </div>
                <div style="background:var(--card-bg); padding:20px; border-radius:10px; border:1px solid var(--border);">
                    <h3>Custom Game</h3>
                    <button onclick="document.getElementById('game-frame').src='https://slope-game.github.io/'" style="margin-top:10px; padding:5px 15px;">Load</button>
                </div>
                <div style="background:var(--card-bg); padding:20px; border-radius:10px; border:1px solid var(--border);">
                    <h3>Monster Chase</h3>
                    <button onclick="loadMonsterGame()" style="margin-top:10px; padding:5px 15px; background-color: #ff9800; color: white; border: none; cursor: pointer;">Play Now</button>
                </div>
            </div>
            <br>
            <p style="font-size: 0.9rem; color: grey;">Click inside the game to play. Use Arrow Keys to move.</p>
            <iframe id="game-frame" src=""></iframe>
        </div>

        <div id="chatterbox" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0;">ChatterBox</h2>
                <button class="fs-btn" onclick="toggleFullscreenChat()">‚õ∂ Fullscreen</button>
            </div>
            <iframe src="https://whatever-works123.github.io/Chatter-Box/"></iframe>
        </div>

        <div id="socials" class="section">
            <h2>Social Feed</h2>
            <iframe src="https://bing.com"></iframe>
        </div>

        <div id="settings" class="section">
            <h2>Settings</h2>
            <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 20px;">
                <h3>üîí Stealth Mode</h3>
                <p style="margin-bottom:10px;">Toggle between School and Fun mode.</p>
                <button onclick="toggleMode()" style="padding:10px 20px; cursor:pointer; background:var(--accent); color:white; border:none; border-radius:5px;">Switch Mode</button>
                <p style="font-size:0.8rem; color:grey; margin-top:10px;">Tip: Press <strong>ESC</strong> to panic switch.</p>
            </div>
            <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border);">
                <h3>üé® Appearance</h3>
                <p style="margin-bottom:10px;">Switch color theme.</p>
                <button onclick="toggleTheme()" style="padding:10px 20px; cursor:pointer; background:var(--text-primary); color:var(--bg-color); border:none; border-radius:5px;">Toggle Theme</button>
            </div>
        </div>
    </main>

    <script id="monster-game-template" type="text/plain">
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Monster Object</title>
            <style type="text/css">
                body { overflow: hidden; margin: 0; background: #222; font-family: sans-serif; }
                #stage { position: relative; width: 100vw; height: 100vh; }
                .monster {
                    position: absolute;
                    border-radius: 50%;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-weight: bold;
                    color: rgba(0,0,0,0.5);
                    box-shadow: 0 0 10px rgba(255,255,255,0.5);
                    user-select: none;
                    cursor: pointer;
                }
            </style>
        </head>
        <body>
            <div id="stage"></div>
            <script>
                console.log('Game Starting...');

                var refreshRate = 50;
                var windowWidth = window.innerWidth;
                var windowHeight = window.innerHeight;

                // Handle resize
                window.onresize = function() {
                    windowWidth = window.innerWidth;
                    windowHeight = window.innerHeight;
                };

                var pxToNumber = function(str) {
                    return Number(str.replace('px', ''));
                }

                var Monster = function() {
                    var self = this;
                    this.speedX = 0;
                    this.speedY = 0;
                    this.startX = 0;
                    this.startY = 0;
                    this.size = 100;
                    this.color = 'ff00ff';
                    this.domId = false;
                    this.domElement = false;
                    this.cycle = 0;
                    
                    this.init = function() {
                        // FIXED: Use createElement instead of innerHTML to prevent overwriting other monsters
                        var el = document.createElement('div');
                        el.className = 'monster';
                        el.id = this.domId;
                        el.innerText = '(o_o)';
                        
                        // Set initial styles
                        el.style.left = this.startX + 'px';
                        el.style.top = this.startY + 'px';
                        el.style.backgroundColor = '#' + this.color;
                        el.style.width = this.size + 'px';
                        el.style.height = this.size + 'px';
                        el.style.fontSize = (this.size / 3) + 'px';

                        document.getElementById('stage').appendChild(el);
                        
                        this.domElement = el;
                        
                        this.interval = setInterval(function() {
                            self.draw();
                        }, refreshRate);
                    };
                    
                    this.move = function() {
                        var currentX = pxToNumber(this.domElement.style.left);
                        var newX = currentX + this.speedX;
                        var currentY = pxToNumber(this.domElement.style.top);
                        var newY = currentY + this.speedY;
                        
                        // Bounce off floor/ceiling
                        if(newY + this.size >= windowHeight && this.speedY > 0) {
                            this.speedY = this.speedY * -1;
                        }
                        if(newY <= 0 && this.speedY < 0) {
                            this.speedY = this.speedY * -1;
                        }
                        
                        // Wrap around sides
                        if(newX >= windowWidth && this.speedX > 0) {
                            newX = -this.size;
                        }
                        if(newX + this.size < 0 && this.speedX < 0) {
                            newX = windowWidth;
                        }
                        
                        this.domElement.style.left = newX + 'px';
                        this.domElement.style.top = newY + 'px';
                    };
                    
                    this.setImage = function() {
                        if(this.speedX > 0) {
                            this.domElement.style.transform = 'scaleX(1)';
                        }
                        if(this.speedX < 0) {
                            this.domElement.style.transform = 'scaleX(-1)';
                        }
                    };
                    
                    this.draw = function() {
                        // Re-fetch element just in case, but rely on variable
                        if(!this.domElement) this.domElement = document.getElementById(this.domId);
                        
                        this.domElement.onclick = function(event){
                            this.style.border = "3px solid white";
                            currentMonster = self;
                            console.log("Selected monster " + self.domId);
                        };
                        
                        this.move();
                        this.setImage();
                    };
                };

                var monsters = [];
                for (var i=0; i<30; i++) {
                    monsters[i] = new Monster();
                    monsters[i].domId = 'monster_' + i;
                    monsters[i].speedX = Math.floor(Math.random() * 10 - 5);
                    monsters[i].speedY = Math.floor(Math.random() * 10 - 5);
                    monsters[i].startX = Math.floor(Math.random() * (windowWidth - 100));
                    monsters[i].startY = Math.floor(Math.random() * (windowHeight - 100));
                    monsters[i].size = Math.floor(Math.random() * 50 + 30);
                    monsters[i].color = Math.floor(Math.random()*16777215).toString(16);
                    monsters[i].init();
                }

                var currentMonster = monsters[0];

                window.addEventListener('keydown', function(event){
                    if(!currentMonster) return;
                    // Prevent page scrolling with arrow keys
                    if([32, 37, 38, 39, 40].indexOf(event.keyCode) > -1) {
                        event.preventDefault();
                    }
                    
                    switch (event.keyCode) {
                        case 39: currentMonster.speedX += 1; break; // Right
                        case 37: currentMonster.speedX -= 1; break; // Left
                        case 40: currentMonster.speedY += 1; break; // Down
                        case 38: currentMonster.speedY -= 1; break; // Up
                        case 32: // Spacebar
                            currentMonster.speedX = 0;
                            currentMonster.speedY = 0;
                            break;
                    }
                });
            </script>
        </body>
        </html>
    </script>

    <script>
        // ==========================================
        // FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyABujQAAYKhMxJddtJSvTShWEZ8bqF3kzA",
            authDomain: "chatterbox3000-fb3e2.firebaseapp.com",
            databaseURL: "https://chatterbox3000-fb3e2-default-rtdb.firebaseio.com",
            projectId: "chatterbox3000-fb3e2",
            storageBucket: "chatterbox3000-fb3e2.firebasestorage.app",
            messagingSenderId: "298622361038",
            appId: "1:298622361038:web:c1e46432470dbce92a5f9f"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.database();
        
        let currentUser = null;
        let todoArray = [];

        // ==========================================
        // AUTH LOGIC
        // ==========================================
        
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('user-display').innerText = user.email;
                loadUserData(); 
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                currentUser = null;
            }
        });

        function loginUser() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');
            errorMsg.innerText = "Logging in...";
            auth.signInWithEmailAndPassword(email, pass)
                .catch((error) => { errorMsg.innerText = "Error: " + error.message; });
        }

        function logoutUser() {
            auth.signOut();
            location.reload();
        }

        // ==========================================
        // DATABASE LOGIC
        // ==========================================

        function showSaveStatus() {
            const status = document.getElementById('save-status');
            status.style.opacity = '1';
            setTimeout(() => { status.style.opacity = '0'; }, 2000);
        }

        function loadUserData() {
            if(!currentUser) return;
            const userRef = db.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if(data.math) document.getElementById('note-math').value = data.math;
                    if(data.science) document.getElementById('note-science').value = data.science;
                    if(data.ela) document.getElementById('note-ela').value = data.ela;
                    if(data.history) document.getElementById('note-history').value = data.history;
                    if(data.todos) { todoArray = data.todos; renderTodos(); }
                }
            });
        }

        function saveData(subject) {
            if(!currentUser) return;
            const noteContent = document.getElementById('note-' + subject).value;
            db.ref('users/' + currentUser.uid + '/' + subject).set(noteContent)
                .then(() => showSaveStatus());
        }

        // ==========================================
        // TODO LIST
        // ==========================================
        function addTodo() {
            const input = document.getElementById('newTodo');
            const text = input.value;
            if (!text) return;
            todoArray.push(text);
            updateTodoDB();
            renderTodos();
            input.value = '';
        }

        function removeTodo(index) {
            todoArray.splice(index, 1);
            updateTodoDB();
            renderTodos();
        }

        function updateTodoDB() {
            if(!currentUser) return;
            db.ref('users/' + currentUser.uid + '/todos').set(todoArray)
                .then(() => showSaveStatus());
        }

        function renderTodos() {
            const list = document.getElementById('todoList');
            list.innerHTML = '';
            todoArray.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = 'todo-item';
                li.innerHTML = `<span>${task}</span> <span class="delete-btn" onclick="removeTodo(${index})">√ó</span>`;
                list.appendChild(li);
            });
        }

        // ==========================================
        // UI & TOOLS
        // ==========================================
        
        function showSection(id) {
            const chatterDiv = document.getElementById('chatterbox');
            if(chatterDiv.classList.contains('fullscreen-active')) {
                toggleFullscreenChat();
            }

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const btn = Array.from(document.querySelectorAll('.nav-btn')).find(b => b.getAttribute('onclick').includes(id));
            if(btn) btn.classList.add('active');
        }

        function toggleMode() {
            const body = document.body;
            if (body.classList.contains('mode-school')) {
                body.classList.remove('mode-school');
                body.classList.add('mode-fun');
                showSection('fun-home');
            } else {
                body.classList.remove('mode-fun');
                body.classList.add('mode-school');
                showSection('school-home');
            }
        }

        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            body.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
        }

        function calc(val) {
            const display = document.getElementById('calcDisplay');
            if (val === 'C') { display.value = ''; }
            else if (val === '=') { 
                try { display.value = eval(display.value); } catch { display.value = 'Error'; }
            } 
            else { display.value += val; }
        }

        function toggleFullscreenChat() {
            const chatDiv = document.getElementById('chatterbox');
            chatDiv.classList.toggle('fullscreen-active');
        }

        function loadMonsterGame() {
            const iframe = document.getElementById('game-frame');
            const gameCode = document.getElementById('monster-game-template').textContent;
            iframe.srcdoc = gameCode;
            iframe.onload = function() {
                iframe.contentWindow.focus();
            };
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                const chatDiv = document.getElementById('chatterbox');
                if(chatDiv.classList.contains('fullscreen-active')) {
                    chatDiv.classList.remove('fullscreen-active');
                }
                const body = document.body;
                if (body.classList.contains('mode-fun')) {
                    body.classList.remove('mode-fun');
                    body.classList.add('mode-school');
                    showSection('school-home');
                }
            }
        });
    </script>
</body>
</html>
