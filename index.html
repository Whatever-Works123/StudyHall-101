<script>
    // --- 1. FIREBASE CONFIGURATION ---
    // (Keep your existing Firebase config here if you added it!)
    const firebaseConfig = {
        apiKey: "PASTE_YOUR_API_KEY_HERE", 
        // ... rest of your config
    };

    // Initialize Firebase safely
    let db;
    let userId;
    try {
        if(firebaseConfig && firebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE" && typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        }
    } catch(e) { console.log("Local Mode Only"); }

    // --- 2. STATE & INIT ---
    const appState = {
        theme: localStorage.getItem('theme') || 'light',
        mood: localStorage.getItem('mood') || '',
        isPlaying: false,
        currentStation: 'lofi',
        activeNoteId: null
    };

    // --- 3. UNBLOCKABLE AUDIO SOURCES ---
    // Switched to GitHub Raw & Code-Generated Audio
    const stations = {
        // Lofi: Hosted on GitHub (Usually unblocked)
        lofi: "https://raw.githubusercontent.com/sasi-k/lofi-player/master/public/music/1.mp3",
        
        // Piano: Hosted on GitHub
        piano: "https://raw.githubusercontent.com/pffy/mp3-piano-sound/master/mp3/c4.mp3", // Note: Switched to a test tone first to verify

        // We will actually use a specific GitHub hosted song for Piano to ensure it plays longer
        piano_full: "https://raw.githubusercontent.com/josephernest/BigSound/master/examples/mp3/02.mp3", 

        // Generators (100% Unblockable because they are code)
        rain: "generate:rain",
        noise: "generate:brown"
    };

    let audioCtx, jsNode, audioNode, saveTimeout;

    function init() {
        if(appState.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
        if(appState.mood) document.body.className = appState.mood;
        
        // User ID Logic
        userId = localStorage.getItem('study_user_id');
        if(!userId) {
            userId = 'student_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('study_user_id', userId);
        }
        const userDisplay = document.getElementById('user-id-display');
        if(userDisplay) userDisplay.value = userId;

        updateClock();
        setInterval(updateClock, 1000);
        loadSchedule();
        loadTodos();
        renderNotebookMenu();
        
        // Add Error Listener to Audio Player
        const audioEl = document.getElementById('audio-engine');
        if(audioEl) {
            audioEl.onerror = function() {
                const status = document.getElementById('stream-status');
                status.innerText = "❌ Blocked by School Filter. Switching to Generator...";
                status.style.color = "var(--danger)";
                // Fallback to brown noise if file fails
                setTimeout(() => changeStation('noise'), 2000);
            };
        }
    }

    // --- 4. AUDIO ENGINE ---
    const audioEl = document.getElementById('audio-engine');

    function changeStation(id) {
        document.querySelectorAll('.station-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('st-' + id);
        if(btn) btn.classList.add('active');
        
        appState.currentStation = id;
        if(appState.isPlaying) {
            playAudioSource();
        }
    }

    function toggleAudio() {
        const btn = document.getElementById('main-play-btn');
        const pill = document.getElementById('now-playing-pill');
        const record = document.getElementById('record-player');
        
        if(appState.isPlaying) {
            // STOP
            audioEl.pause();
            stopProceduralAudio();
            appState.isPlaying = false;
            
            btn.innerHTML = '<i class="fas fa-play"></i> Start';
            if(record) record.classList.remove('playing');
            if(pill) pill.style.opacity = '0';
            document.getElementById('stream-status').innerText = "";
        } else {
            // PLAY
            playAudioSource();
            appState.isPlaying = true;
            
            btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
            if(record) record.classList.add('playing');
            if(pill) pill.style.opacity = '1';
        }
    }

    function playAudioSource() {
        const status = document.getElementById('stream-status');
        audioEl.pause();
        stopProceduralAudio();

        let source = stations[appState.currentStation];
        
        // Fix for Piano key mapping
        if(appState.currentStation === 'piano') source = stations.piano_full;

        if (source.startsWith("generate:")) {
            // CODE GENERATED (UNBLOCKABLE)
            const type = source.split(':')[1];
            startProceduralAudio(type);
            status.innerText = "⚡ Generating " + type + " (Local)";
            status.style.color = "var(--accent)";
        } else {
            // GITHUB FILE STREAM
            status.innerText = "⌛ Buffering from GitHub...";
            status.style.color = "var(--text-secondary)";
            
            audioEl.src = source;
            audioEl.volume = document.querySelector('input[type=range]').value;
            
            // Attempt play
            const playPromise = audioEl.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    status.innerText = "✅ Playing (GitHub Source)";
                    status.style.color = "var(--success)"; // Green
                })
                .catch(error => {
                    console.error("Play Error:", error);
                    status.innerText = "⚠️ Network Blocked. Try 'Brown Noise'.";
                });
            }
        }
    }

    function setVolume(val) {
        if(audioEl) audioEl.volume = val;
        if(jsNode) jsNode.gain.value = val * 0.15;
    }

    // --- 5. PROCEDURAL AUDIO (The Math Stuff) ---
    function startProceduralAudio(type) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const bufferSize = 2 * audioCtx.sampleRate;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);

        for (let i = 0; i < bufferSize; i++) {
            const white = Math.random() * 2 - 1;
            
            if(type === 'brown') {
                // Brown Noise Algorithm
                let lastOut = 0;
                data[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = data[i];
                data[i] *= 3.5; 
            } 
            else if (type === 'rain') {
                // Pink Noise Algorithm (Sounds like rain)
                let b0, b1, b2, b3, b4, b5, b6;
                b0=b1=b2=b3=b4=b5=b6=0.0;
                b0 = 0.99886 * b0 + white * 0.0555179;
                b1 = 0.99332 * b1 + white * 0.0750759;
                b2 = 0.96900 * b2 + white * 0.1538520;
                b3 = 0.86650 * b3 + white * 0.3104856;
                b4 = 0.55000 * b4 + white * 0.5329522;
                b5 = -0.7616 * b5 - white * 0.0168980;
                data[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                data[i] *= 0.11; 
            }
        }

        audioNode = audioCtx.createBufferSource();
        audioNode.buffer = buffer;
        audioNode.loop = true;
        jsNode = audioCtx.createGain();
        jsNode.gain.value = (audioEl ? audioEl.volume : 0.5) * 0.15;
        
        audioNode.connect(jsNode);
        jsNode.connect(audioCtx.destination);
        audioNode.start();
    }

    function stopProceduralAudio() {
        if(audioNode) {
            audioNode.stop();
            audioNode = null;
        }
    }

    // --- 6. STANDARD APP LOGIC ---
    function handleNoteInput() {
        const status = document.getElementById('cloud-text');
        const icon = document.querySelector('.cloud-status');
        const val = document.getElementById('current-note').value;
        localStorage.setItem('note_' + appState.activeNoteId, val);
        
        if(status) {
            status.innerText = "Saving...";
            if(icon) {
                icon.classList.add('saving');
                icon.classList.remove('synced');
            }
        }

        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveToCloud(val);
        }, 1000);
    }

    function saveToCloud(content) {
        if(db && userId) {
            db.ref('users/' + userId + '/notes/' + appState.activeNoteId).set(content)
                .then(() => {
                    const status = document.getElementById('cloud-text');
                    const icon = document.querySelector('.cloud-status');
                    if(status) status.innerText = "Synced";
                    if(icon) {
                        icon.classList.remove('saving');
                        icon.classList.add('synced');
                    }
                })
                .catch(e => console.log("Cloud save failed"));
        } else {
            const status = document.getElementById('cloud-text');
            if(status) status.innerText = "Local Mode";
        }
    }

    function fetchFromCloud(noteId) {
        if(db && userId) {
            const status = document.getElementById('cloud-text');
            if(status) status.innerText = "Syncing...";
            
            db.ref('users/' + userId + '/notes/' + noteId).once('value', (snap) => {
                const cloudContent = snap.val();
                if(cloudContent) {
                    document.getElementById('current-note').value = cloudContent;
                    localStorage.setItem('note_' + noteId, cloudContent);
                } else {
                    document.getElementById('current-note').value = localStorage.getItem('note_' + noteId) || "";
                }
                if(status) status.innerText = "Synced";
            });
        } else {
            document.getElementById('current-note').value = localStorage.getItem('note_' + noteId) || "";
        }
    }

    // UI Helpers
    function setMood(moodClass) {
        document.body.className = ''; document.body.removeAttribute('data-theme');
        if(moodClass) document.body.classList.add(moodClass);
        if(moodClass === 'mood-midnight') document.body.setAttribute('data-theme', 'dark');
        localStorage.setItem('mood', moodClass);
    }
    
    function toggleTheme() {
        const next = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        localStorage.setItem('mood', '');
        document.body.className = '';
    }

    function showSection(id, btn) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(btn) {
            document.querySelectorAll('.nav-btn, .sub-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('page-title').innerText = btn.innerText.trim();
        }
    }

    function toggleZenMode() { document.body.classList.toggle('zen-mode'); }
    function updateClock() { 
        const el = document.getElementById('clock');
        if(el) el.innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 
    }

    // Data Loaders
    const defaultSchedule = [ { id: 'p1', class: "Mathematics" }, { id: 'p2', class: "History" }, { id: 'p3', class: "Science" }, { id: 'p4', class: "English" }, { id: 'p5', class: "Elective" } ];
    
    function loadSchedule() {
        const saved = JSON.parse(localStorage.getItem('study_schedule')) || defaultSchedule;
        const container = document.getElementById('schedule-list');
        if(!container) return;
        container.innerHTML = '';
        saved.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'schedule-item';
            div.innerHTML = `<div style="width:20%; font-weight:600; color:var(--accent);">Period ${index+1}</div><div style="width:80%;"><input type="text" value="${item.class}" onchange="updateClass(${index}, this.value)"></div>`;
            container.appendChild(div);
        });
    }

    function updateClass(index, newName) {
        let schedule = JSON.parse(localStorage.getItem('study_schedule')) || defaultSchedule;
        schedule[index].class = newName;
        localStorage.setItem('study_schedule', JSON.stringify(schedule));
        renderNotebookMenu();
    }

    function renderNotebookMenu() {
        const schedule = JSON.parse(localStorage.getItem('study_schedule')) || defaultSchedule;
        const submenu = document.getElementById('notebook-submenu');
        if(!submenu) return;
        submenu.innerHTML = '';
        schedule.forEach(item => {
            const btn = document.createElement('button');
            btn.className = 'sub-btn';
            btn.innerHTML = `<i class="fas fa-circle" style="font-size:0.5rem; margin-right:8px;"></i> ${item.class}`;
            btn.onclick = () => openNote(item.id, item.class, btn);
            submenu.appendChild(btn);
        });
        const miscBtn = document.createElement('button');
        miscBtn.className = 'sub-btn';
        miscBtn.innerHTML = `<i class="fas fa-circle" style="font-size:0.5rem; margin-right:8px;"></i> Brainstorming`;
        miscBtn.onclick = () => openNote('misc', 'Brainstorming', miscBtn);
        submenu.appendChild(miscBtn);
    }

    function toggleNotebookMenu(btn) {
        const menu = document.getElementById('notebook-submenu');
        if(menu) {
            menu.classList.toggle('open');
            const arrow = btn.querySelector('.fa-chevron-down');
            if(arrow) arrow.style.transform = menu.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
        }
    }

    function openNote(noteId, noteTitle, btnElement) {
        document.querySelectorAll('.nav-btn, .sub-btn').forEach(el => el.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        showSection('notebook-view');
        
        const titleEl = document.getElementById('page-title');
        if(titleEl) titleEl.innerText = noteTitle;
        
        appState.activeNoteId = noteId;
        fetchFromCloud(noteId);
    }

    function addTodo() {
        const input = document.getElementById('newTodo');
        const val = input.value.trim();
        if(!val) return;
        const tasks = JSON.parse(localStorage.getItem('study_todos') || '[]');
        tasks.push(val);
        localStorage.setItem('study_todos', JSON.stringify(tasks));
        input.value = '';
        loadTodos();
    }

    function loadTodos() {
        const tasks = JSON.parse(localStorage.getItem('study_todos') || '[]');
        const list = document.getElementById('todoList');
        const dashList = document.getElementById('dashboard-todo-list');
        if(list) list.innerHTML = ''; 
        if(dashList) dashList.innerHTML = '';
        
        if(dashList && tasks.length === 0) dashList.innerHTML = '<li>No tasks yet.</li>';
        
        tasks.forEach((t, i) => {
            if(list) {
                const item = document.createElement('div');
                item.style.cssText = "padding:12px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;";
                item.innerHTML = `<span>${t}</span> <button class="btn btn-danger" onclick="removeTodo(${i})" style="font-size:0.8rem; padding:5px;">Done</button>`;
                list.appendChild(item);
            }
            if(dashList && i < 3) dashList.innerHTML += `<li>${t}</li>`;
        });
    }

    function removeTodo(i) {
        const tasks = JSON.parse(localStorage.getItem('study_todos') || '[]');
        tasks.splice(i, 1);
        localStorage.setItem('study_todos', JSON.stringify(tasks));
        loadTodos();
    }

    function calc(val) {
        const d = document.getElementById('calcDisplay');
        if(!d) return;
        if(val==='C') d.value = '';
        else if(val==='=') { try { d.value = eval(d.value); } catch { d.value = 'Error'; } }
        else d.value += val;
    }

    let tmr;
    function toggleTimer() {
        const btn = document.getElementById('timer-btn');
        if(tmr) { 
            clearInterval(tmr); tmr = null; 
            if(btn) btn.innerText = "Start"; 
            if(btn) btn.classList.remove('btn-danger'); 
        } else {
            if(btn) btn.innerText = "Pause"; 
            if(btn) btn.classList.add('btn-danger');
            tmr = setInterval(() => {
                const el = document.getElementById('timer-display');
                if(!el) return;
                let [m, s] = el.innerText.split(':').map(Number);
                if(s===0) { if(m===0) { clearInterval(tmr); return; } m--; s=59; } else s--;
                el.innerText = `${m}:${s<10?'0'+s:s}`;
            }, 1000);
        }
    }

    function resetTimer() { 
        clearInterval(tmr); tmr=null; 
        const el = document.getElementById('timer-display');
        const btn = document.getElementById('timer-btn');
        if(el) el.innerText="25:00"; 
        if(btn) btn.innerText="Start"; 
        if(btn) btn.classList.remove('btn-danger'); 
    }

    function clearData() {
        if(confirm("Delete all notes and todos?")) {
            localStorage.clear();
            location.reload();
        }
    }

    window.onload = init;
</script>
