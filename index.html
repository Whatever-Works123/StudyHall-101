<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHall v20: Cloud</title>

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* DARK (Default) */
            --bg-body: #2C2F36;
            --bg-sidebar: #23262B;
            --bg-card: #343840;
            --bg-input: #1F2226;
            --text-main: #ECEFF4;
            --text-muted: #9CA3AF;
            --accent: #EBCB8B;       
            --accent-hover: #D08770; 
            --success: #A3BE8C;       
            --danger: #BF616A;        
            --paper-bg: #FFF9E5;      
            --paper-text: #2C2F36;
            --radius: 20px;
            --font: 'Nunito', sans-serif;
            --shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        [data-theme="light"] {
            /* LIGHT (Cream & Orange) */
            --bg-body: #F9F5EB;       
            --bg-sidebar: #FFFBF2;    
            --bg-card: #FFFFFF;       
            --bg-input: #F0EBE0;      
            --text-main: #5C5446;     
            --text-muted: #9C9488;    
            --accent: #FF9F43;        
            --accent-hover: #FF7F00;  
            --success: #2ECC71;       
            --danger: #FF6B6B;
            --paper-bg: #FFFFFF;
            --paper-text: #5C5446;
            --shadow: 0 4px 20px rgba(92, 84, 70, 0.08); 
        }

        * { box-sizing: border-box; transition: background 0.3s ease, color 0.3s ease, border 0.3s ease; outline: none; }
        body { margin: 0; font-family: var(--font); background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 260px; background: var(--bg-sidebar); display: flex; flex-direction: column; padding: 25px 20px; flex-shrink: 0; border-right: 1px solid rgba(0,0,0,0.05); }
        .app-title { font-size: 1.4rem; font-weight: 800; color: var(--accent); margin-bottom: 35px; display: flex; align-items: center; gap: 12px; }
        .nav-link { display: flex; align-items: center; gap: 15px; padding: 14px 15px; margin-bottom: 8px; border-radius: var(--radius); color: var(--text-muted); cursor: pointer; font-weight: 700; font-size: 1rem; border: none; background: none; width: 100%; text-align: left; }
        .nav-link:hover { background: var(--bg-input); color: var(--text-main); transform: translateX(3px); }
        .nav-link.active { background: var(--bg-card); color: var(--accent); box-shadow: var(--shadow); }

        /* --- USER AREA --- */
        .spacer { flex: 1; }
        .user-area { background-color: var(--bg-input); padding: 12px; border-radius: var(--radius); display: flex; align-items: center; gap: 12px; margin-top: 15px; }
        .avatar-container { width: 44px; height: 44px; cursor: pointer; flex-shrink: 0; }
        .avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-card); background: var(--bg-card); }
        .user-info { flex: 1; overflow: hidden; cursor: pointer; padding: 0 5px; }
        .user-name { font-weight: 800; font-size: 0.95rem; white-space: nowrap; }
        .user-sub { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; font-weight: 600; }
        .shop-btn { background: var(--bg-card); border: none; color: var(--accent); width: 40px; height: 40px; border-radius: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .shop-btn:hover { background: var(--accent); color: white; transform: scale(1.05); }

        /* --- MAIN --- */
        .main { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; }
        .header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .header h1 { font-size: 2.2rem; margin: 0; font-weight: 800; letter-spacing: -1px; }
        .header p { color: var(--text-muted); margin: 8px 0 0; font-size: 1.1rem; }
        .quote-box { font-style: italic; color: var(--accent); font-weight: 600; margin-bottom: 5px; opacity: 0.8; font-size: 0.9rem; }
        
        .cloud-status { font-size: 0.8rem; font-weight: 700; color: var(--success); display: flex; align-items: center; gap: 5px; background: var(--bg-input); padding: 5px 12px; border-radius: 15px; }
        .status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); }
        .status-offline { color: var(--text-muted); } .status-offline .status-dot { background: var(--danger); box-shadow: none; }

        .card { background: var(--bg-card); border-radius: var(--radius); padding: 30px; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.02); }

        /* --- WIDGETS --- */
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .badge { background: var(--bg-input); padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; color: var(--accent); display: inline-flex; align-items: center; gap: 5px; }
        .xp-track { background: var(--bg-input); height: 14px; border-radius: 10px; overflow: hidden; margin-bottom: 8px; }
        .xp-fill { background: var(--accent); width: 0%; height: 100%; transition: width 0.5s; }

        .pet-card { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; position: relative; }
        .pet-display { font-size: 5rem; transition: transform 0.5s ease; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2)); }
        .pet-bubble { position: absolute; top: 10px; right: 20px; background: var(--bg-body); padding: 5px 10px; border-radius: 10px; font-size: 0.8rem; font-weight: 700; opacity: 0; transition: opacity 0.3s; transform: translateY(10px); }
        .pet-card:hover .pet-bubble { opacity: 1; transform: translateY(0); }
        .sleeping { animation: breathe 3s infinite ease-in-out; opacity: 0.7; transform: scale(0.95); }
        .zzz { position: absolute; top: 20px; right: 40%; font-weight: 800; color: var(--text-muted); animation: floatUp 2s infinite; opacity: 0; }
        .sleeping + .zzz { opacity: 1; }
        @keyframes breathe { 0%, 100% { transform: scale(0.95); } 50% { transform: scale(1.0); } }
        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-30px) rotate(10deg); opacity: 0; } }

        /* To-Do */
        .todo-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .todo-input { flex: 1; background: var(--bg-input); border: none; padding: 12px 20px; border-radius: 30px; color: var(--text-main); font-family: var(--font); font-weight: 600; }
        .btn-add { background: var(--accent); border: none; width: 45px; height: 45px; border-radius: 50%; color: white; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .todo-list { list-style: none; padding: 0; margin: 0; }
        .todo-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--bg-input); }
        .todo-item:last-child { border-bottom: none; }
        .todo-text { flex: 1; margin-left: 15px; font-weight: 600; cursor: pointer; }
        .todo-check { width: 22px; height: 22px; border: 2px solid var(--text-muted); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: transparent; }
        .todo-item.done .todo-text { text-decoration: line-through; color: var(--text-muted); }
        .todo-item.done .todo-check { background: var(--success); border-color: var(--success); color: white; }
        .todo-del { color: var(--danger); cursor: pointer; opacity: 0.5; padding: 5px; }
        .todo-del:hover { opacity: 1; }

        /* Ach */
        .badge-row { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
        .ach-badge { min-width: 60px; height: 60px; background: var(--bg-input); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--text-muted); position: relative; border: 2px solid transparent; }
        .ach-badge.unlocked { background: var(--bg-card); border-color: var(--accent); color: var(--text-main); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* Timer */
        .timer-wrapper { text-align: center; padding: 40px 0; }
        .big-timer { font-size: 6rem; font-weight: 800; color: var(--text-main); font-variant-numeric: tabular-nums; line-height: 1; margin: 20px 0; letter-spacing: -2px; }
        .timer-status { font-size: 1.1rem; color: var(--accent); font-weight: 700; text-transform: uppercase; letter-spacing: 2px; }
        .btn-group { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }
        .btn { padding: 12px 30px; border-radius: 30px; border: none; font-weight: 700; cursor: pointer; font-size: 1rem; background: var(--bg-input); color: var(--text-main); display: inline-flex; align-items: center; gap: 10px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { transform: translateY(-3px); background: var(--accent-hover); }
        .btn-danger { background: var(--danger); color: white; }

        /* Notes */
        #notepad { width: 100%; height: 70vh; background: var(--paper-bg); color: var(--paper-text); padding: 40px; border-radius: var(--radius); font-family: 'Courier New', Courier, monospace; line-height: 1.8; border: none; font-size: 1.15rem; resize: none; box-shadow: var(--shadow); margin-bottom: 15px; }
        .note-controls { display: flex; justify-content: flex-end; gap: 10px; }

        /* Shop */
        .shop-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .shop-item { background: var(--bg-input); border-radius: var(--radius); padding: 25px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s; position: relative; }
        .shop-item:hover { transform: translateY(-5px); border-color: var(--accent); background: var(--bg-card); }
        .shop-item.owned { opacity: 0.8; border-color: var(--success); }
        .shop-item.equipped { opacity: 1; border-color: var(--accent); box-shadow: 0 0 15px rgba(255, 159, 67, 0.2); background: var(--bg-card); }
        .item-type { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; opacity: 0.5; font-weight: 700; }

        .hidden { display: none !important; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .stat-box { background: var(--bg-card); padding: 25px; border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); }
        .stat-num { font-size: 2.2rem; font-weight: 800; color: var(--text-main); display: block; margin-bottom: 5px; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }

        /* FX */
        .fx-fire { box-shadow: 0 0 15px #BF616A; border-color: #BF616A !important; }
        .fx-neon { box-shadow: 0 0 15px #A3BE8C; border-color: #A3BE8C !important; }
        .fx-gold { border-color: #FFD700 !important; box-shadow: 0 0 15px #FFD700; }
        .fx-rainbow { border: 3px solid transparent !important; background: linear-gradient(var(--bg-card), var(--bg-card)) padding-box, linear-gradient(45deg, red, orange, yellow, green, blue, violet) border-box; }

    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="app-title"><i class="fas fa-shapes"></i> StudyHall</div>
        <button class="nav-link active" onclick="showPage('home', this)"><i class="fas fa-home"></i> Home</button>
        <button class="nav-link" onclick="showPage('notes', this)"><i class="fas fa-pencil-alt"></i> Study Notes</button>
        <button class="nav-link" onclick="showPage('focus', this)"><i class="fas fa-clock"></i> Focus</button>
        <button class="nav-link" onclick="showPage('tools', this)"><i class="fas fa-calculator"></i> Tools</button>
        <div class="spacer"></div>
        <div class="user-area">
            <div class="avatar-container" onclick="document.getElementById('file-input').click()" title="Change Avatar">
                <img src="" id="user-avatar" class="avatar-img">
            </div>
            <div class="user-info" onclick="showPage('settings', null)">
                <div class="user-name">Student</div>
                <div class="user-sub"><i class="fas fa-coins" style="color:var(--accent)"></i> <span id="coin-display">0</span></div>
            </div>
            <button class="shop-btn" onclick="showPage('shop', null)"><i class="fas fa-store"></i></button>
        </div>
    </nav>
    <input type="file" id="file-input" accept="image/*" onchange="uploadAvatar(this)" style="display:none;">

    <main class="main">
        <div class="header">
            <div>
                <div class="quote-box" id="daily-quote">"Loading..."</div>
                <h1 id="page-title">Home</h1>
                <p id="page-desc">Your cozy productivity corner.</p>
            </div>
            <div id="cloud-status" class="cloud-status status-offline"><div class="status-dot"></div> Connecting...</div>
        </div>

        <div id="home" class="page">
            <div class="grid-2">
                <div>
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <div>
                                <span class="badge" id="lvl-display">Lvl 1</span>
                                <span class="badge" style="color:var(--text-muted);"><i class="fas fa-fire"></i> <span id="streak-display">0</span> Day Streak</span>
                            </div>
                            <span style="font-size:0.8rem; font-weight:700; color:var(--text-muted);" id="xp-text">0/1000 XP</span>
                        </div>
                        <div class="xp-track"><div id="xp-bar" class="xp-fill"></div></div>
                        <p style="font-size:0.8rem; font-weight:700; color:var(--text-muted); margin-bottom:10px; margin-top:20px;">ACHIEVEMENTS</p>
                        <div class="badge-row" id="achievement-row"></div>
                    </div>

                    <div class="card">
                        <h3 style="margin-top:0;">Task Checklist</h3>
                        <div class="todo-input-group">
                            <input type="text" id="todo-input" class="todo-input" placeholder="Add a new task..." onkeypress="if(event.key==='Enter') addTask()">
                            <button class="btn-add" onclick="addTask()"><i class="fas fa-plus"></i></button>
                        </div>
                        <ul class="todo-list" id="todo-list"></ul>
                    </div>
                </div>

                <div>
                    <div class="card pet-card">
                        <div class="pet-bubble" id="pet-msg">I'm ready to study!</div>
                        <div class="pet-display" id="pet-display">üê∂</div>
                        <div class="zzz">Zzz...</div>
                    </div>
                    <div class="stat-box" style="margin-bottom:20px;">
                        <span class="stat-num" id="stat-coins">0</span>
                        <span class="stat-label">Coins</span>
                    </div>
                     <div class="stat-box">
                        <span class="stat-num" id="stat-sessions">0</span>
                        <span class="stat-label">Sessions</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="notes" class="page hidden">
            <div style="position:relative;">
                <textarea id="notepad" placeholder="Type your study notes here..." oninput="handleNoteInput()"></textarea>
                <div class="note-controls">
                    <span id="save-indicator" style="color:var(--success); font-weight:700; opacity:0; margin-right:auto; align-self:center;"><i class="fas fa-check"></i> Saved to Cloud</span>
                    <button class="btn" onclick="exportNotes()"><i class="fas fa-download"></i> Download .txt</button>
                </div>
            </div>
        </div>

        <div id="focus" class="page hidden">
            <div class="card timer-wrapper">
                <div class="timer-status" id="timer-status-text">25 Min Session</div>
                <div class="big-timer" id="timer-display">25:00</div>
                <div class="btn-group">
                    <button class="btn" id="btn-less" onclick="adjustTime(-5)">-5m</button>
                    <button class="btn btn-primary" id="btn-toggle" onclick="toggleTimer()">Start Focus</button>
                    <button class="btn" id="btn-more" onclick="adjustTime(5)">+5m</button>
                    <button class="btn btn-danger hidden" id="btn-reset" onclick="resetTimer()">Reset</button>
                </div>
            </div>
        </div>

        <div id="tools" class="page hidden">
            <div class="card" style="max-width:340px; margin:0 auto; padding:25px;">
                <input id="calc-screen" readonly style="width:100%; background:var(--bg-input); border:none; color:var(--text-main); padding:20px; font-size:1.8rem; text-align:right; border-radius:15px; margin-bottom:20px;">
                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px;">
                    <button class="btn" onclick="c('7')">7</button> <button class="btn" onclick="c('8')">8</button> <button class="btn" onclick="c('9')">9</button> <button class="btn btn-primary" onclick="c('/')">√∑</button>
                    <button class="btn" onclick="c('4')">4</button> <button class="btn" onclick="c('5')">5</button> <button class="btn" onclick="c('6')">6</button> <button class="btn btn-primary" onclick="c('*')">√ó</button>
                    <button class="btn" onclick="c('1')">1</button> <button class="btn" onclick="c('2')">2</button> <button class="btn" onclick="c('3')">3</button> <button class="btn btn-primary" onclick="c('-')">-</button>
                    <button class="btn btn-danger" onclick="c('C')">C</button> <button class="btn" onclick="c('0')">0</button> <button class="btn" onclick="c('=')">=</button> <button class="btn btn-primary" onclick="c('+')">+</button>
                </div>
            </div>
        </div>

        <div id="shop" class="page hidden">
            <div class="shop-tabs">
                <button class="btn btn-primary" onclick="renderShop('all')">All</button>
            </div>
            <div class="shop-grid" id="shop-container"></div>
        </div>

        <div id="settings" class="page hidden">
            <div class="card">
                <h3>Appearance</h3>
                <button class="btn" onclick="toggleTheme()" id="theme-btn">Switch Theme</button>
            </div>
            <div class="card">
                <h3>Cloud Data</h3>
                <p style="color:var(--text-muted)">Your User ID: <span id="uid-display">Loading...</span></p>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8-gihD7c9ARk_EVqcFIveFHqegiFStGQ",
            authDomain: "study-hall-101.firebaseapp.com",
            databaseURL: "https://study-hall-101-default-rtdb.firebaseio.com",
            projectId: "study-hall-101",
            storageBucket: "study-hall-101.firebasestorage.app",
            messagingSenderId: "1008777949689",
            appId: "1:1008777949689:web:0fdc8c099374b695754d28",
            measurementId: "G-K22V4HCKRQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let dbRef = null;

        // Default State (Fallback)
        let state = {
            xp: 0, lvl: 1, coins: 0, sessions: 0, tasksCompleted: 0, streak: 1, lastLogin: '',
            inventory: ['pet_dog'], equippedEffect: '', equippedPet: 'pet_dog', 
            avatar: '', theme: 'dark', todos: [], unlockedAch: [], notes: ''
        };

        // --- AUTH & CONNECT ---
        signInAnonymously(auth).catch((error) => {
            console.error("Auth Failed", error);
            updateStatus(false);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                dbRef = ref(db, 'users/' + user.uid);
                document.getElementById('uid-display').innerText = user.uid;
                updateStatus(true);
                
                // Sync Listener
                onValue(dbRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        state = { ...state, ...data }; // Merge cloud data
                        // Handle missing theme/notes if upgrading
                        if(!state.inventory) state.inventory = ['pet_dog'];
                        if(!state.todos) state.todos = [];
                        
                        // Apply updates
                        window.renderShop();
                        window.renderTodos();
                        window.renderAchievements();
                        window.updateUI();
                        
                        // Load notes and theme specifically
                        document.body.setAttribute('data-theme', state.theme);
                        document.getElementById('notepad').value = state.notes || '';
                    } else {
                        // First time user? Save default state
                        saveToCloud();
                    }
                });
                
                window.init(); // Run standard init logic
            } else {
                updateStatus(false);
            }
        });

        function updateStatus(online) {
            const el = document.getElementById('cloud-status');
            if(online) {
                el.className = 'cloud-status';
                el.innerHTML = '<div class="status-dot"></div> Online';
            } else {
                el.className = 'cloud-status status-offline';
                el.innerHTML = '<div class="status-dot"></div> Offline';
            }
        }

        // --- GLOBAL SAVE FUNCTION ---
        window.saveData = function() {
            if(currentUser && dbRef) {
                // We update state locally first in logic, then push to cloud
                set(dbRef, state);
            }
        }

        function saveToCloud() {
            if(currentUser && dbRef) set(dbRef, state);
        }

        // EXPOSE STATE FOR GLOBAL FUNCTIONS
        window.state = state;
    </script>

    <script>
        // Since we are using modules for Firebase, we need to attach our logic functions to window
        // so the HTML buttons (onclick) can see them.

        const quotes = [
            "Believe you can and you're halfway there.",
            "It always seems impossible until it's done.",
            "Don't watch the clock; do what it does. Keep going.",
            "The secret of getting ahead is getting started.",
            "Small progress is still progress.",
            "Your future needs you. Your past doesn't."
        ];

        const shopItems = [
            { id: 'fx_gold', name: 'Gold Glow', cost: 500, type: 'effect', class: 'fx-gold', icon: 'fa-star' },
            { id: 'fx_fire', name: 'Ember Aura', cost: 1200, type: 'effect', class: 'fx-fire', icon: 'fa-fire' },
            { id: 'fx_neon', name: 'Nature Vibe', cost: 1500, type: 'effect', class: 'fx-neon', icon: 'fa-leaf' },
            { id: 'fx_rainbow', name: 'Prism', cost: 3000, type: 'effect', class: 'fx-rainbow', icon: 'fa-gem' },
            { id: 'pet_dog', name: 'Puppy', cost: 0, type: 'pet', char: 'üê∂' },
            { id: 'pet_cat', name: 'Kitty', cost: 800, type: 'pet', char: 'üê±' },
            { id: 'pet_fox', name: 'Fox', cost: 1500, type: 'pet', char: 'ü¶ä' },
            { id: 'pet_robot', name: 'Bot', cost: 2500, type: 'pet', char: 'ü§ñ' },
            { id: 'pet_bunny', name: 'Bunny', cost: 1000, type: 'pet', char: 'üê∞' }
        ];

        const achievements = [
            { id: 'first_session', name: 'First Steps', icon: 'fa-shoe-prints', req: (s) => s.sessions >= 1, desc: 'Complete 1 session' },
            { id: 'rich', name: 'Savings', icon: 'fa-wallet', req: (s) => s.coins >= 1000, desc: 'Have 1000 Coins' },
            { id: 'streak_3', name: 'On Fire', icon: 'fa-fire', req: (s) => s.streak >= 3, desc: '3 Day Streak' },
            { id: 'tasks_5', name: 'Doer', icon: 'fa-check-double', req: (s) => s.tasksCompleted >= 5, desc: 'Complete 5 Tasks' }
        ];

        let timerInt;
        let saveTimeout;
        let timerDuration = 25;
        let running = false;

        window.init = function() {
            // Setup Random Quote
            document.getElementById('daily-quote').innerText = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
            
            // Check Streak
            checkStreak();
            
            // Initial UI Update (State is loaded by Firebase module)
            updateUI();
            
            // Avatar Init
            const bgCol = window.state.theme === 'dark' ? 'EBCB8B' : 'FF9F43';
            const txtCol = window.state.theme === 'dark' ? '2C2F36' : 'FFFFFF';
            if(!window.state.avatar) document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=Student&background=${bgCol}&color=${txtCol}`;
            else document.getElementById('user-avatar').src = window.state.avatar;
        }

        window.checkStreak = function() {
            const today = new Date().toDateString();
            if(window.state.lastLogin !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if(window.state.lastLogin === yesterday.toDateString()) {
                    window.state.streak++;
                } else if (window.state.lastLogin !== '') {
                    window.state.streak = 1; 
                }
                window.state.lastLogin = today;
                window.saveData();
            }
        }

        window.showPage = function(id, btn) {
            document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(btn) {
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
            }
            const titles = { 'home': 'Home', 'notes': 'Study Notes', 'focus': 'Focus Timer', 'tools': 'Tools', 'shop': 'Marketplace', 'settings': 'Settings' };
            document.getElementById('page-title').innerText = titles[id];
            if(id === 'home') window.updateUI();
        }

        window.updateUI = function() {
            document.getElementById('lvl-display').innerText = "Lvl " + window.state.lvl;
            document.getElementById('xp-text').innerText = `${window.state.xp} / ${window.state.lvl * 1000} XP`;
            document.getElementById('xp-bar').style.width = `${(window.state.xp / (window.state.lvl*1000)) * 100}%`;
            document.getElementById('stat-coins').innerText = window.state.coins;
            document.getElementById('coin-display').innerText = window.state.coins;
            document.getElementById('stat-sessions').innerText = window.state.sessions;
            document.getElementById('streak-display').innerText = window.state.streak;
            document.getElementById('theme-btn').innerText = window.state.theme === 'dark' ? "Switch to Light Mode" : "Switch to Dark Mode";

            // Avatar & Pet
            document.getElementById('user-avatar').className = `avatar-img ${window.state.equippedEffect}`;
            const petObj = shopItems.find(i => i.id === window.state.equippedPet) || shopItems[4];
            document.getElementById('pet-display').innerText = petObj.char;

            window.checkAchievements();
            window.renderAchievements();
        }

        // --- TODO ---
        window.addTask = function() {
            const input = document.getElementById('todo-input');
            if(input.value.trim() === '') return;
            if(!window.state.todos) window.state.todos = [];
            window.state.todos.push({ text: input.value, done: false });
            input.value = '';
            window.saveData(); window.renderTodos();
        }

        window.toggleTask = function(i) {
            window.state.todos[i].done = !window.state.todos[i].done;
            if(window.state.todos[i].done) {
                window.state.coins += 50;
                window.state.tasksCompleted++;
                alert("+50 Coins!");
                window.updateUI();
            }
            window.saveData(); window.renderTodos();
        }

        window.deleteTask = function(i) {
            window.state.todos.splice(i, 1);
            window.saveData(); window.renderTodos();
        }

        window.renderTodos = function() {
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            if(!window.state.todos) return;
            window.state.todos.forEach((task, i) => {
                list.innerHTML += `
                <li class="todo-item ${task.done ? 'done' : ''}">
                    <div class="todo-check" onclick="toggleTask(${i})"><i class="fas fa-check"></i></div>
                    <span class="todo-text" onclick="toggleTask(${i})">${task.text}</span>
                    <i class="fas fa-trash todo-del" onclick="deleteTask(${i})"></i>
                </li>`;
            });
        }

        // --- TIMER ---
        window.adjustTime = function(val) {
            if(running) return;
            timerDuration += val;
            if(timerDuration < 5) timerDuration = 5;
            document.getElementById('timer-display').innerText = `${timerDuration}:00`;
            document.getElementById('timer-status-text').innerText = `${timerDuration} Min Session`;
        }

        window.toggleTimer = function() {
            const btn = document.getElementById('btn-toggle');
            const pet = document.getElementById('pet-display');
            const petMsg = document.getElementById('pet-msg');

            if(running) {
                clearInterval(timerInt);
                running = false;
                btn.innerText = "Resume";
                btn.className = "btn btn-primary";
                document.getElementById('btn-reset').classList.remove('hidden');
                pet.classList.remove('sleeping');
                petMsg.innerText = "Welcome back!";
            } else {
                running = true;
                btn.innerText = "Pause";
                btn.className = "btn"; 
                document.getElementById('btn-reset').classList.add('hidden');
                pet.classList.add('sleeping');
                petMsg.innerText = "Zzz...";
                timerInt = setInterval(tick, 1000);
            }
        }

        window.resetTimer = function() {
            clearInterval(timerInt);
            running = false;
            document.getElementById('btn-toggle').innerText = "Start Focus";
            document.getElementById('btn-toggle').className = "btn btn-primary";
            document.getElementById('btn-reset').classList.add('hidden');
            document.getElementById('timer-display').innerText = `${timerDuration}:00`;
            document.getElementById('pet-display').classList.remove('sleeping');
        }

        function tick() {
            const display = document.getElementById('timer-display');
            let [m, s] = display.innerText.split(':').map(Number);
            if(m === 0 && s === 0) {
                resetTimer();
                alert(`Session Complete! +${timerDuration * 20} XP & Coins`);
                window.state.sessions++;
                window.state.xp += (timerDuration * 20);
                window.state.coins += (timerDuration * 20);
                if(window.state.xp >= window.state.lvl * 1000) { window.state.lvl++; alert("Level Up!"); }
                window.saveData(); window.updateUI();
                return;
            }
            if(s === 0) { m--; s = 59; } else { s--; }
            display.innerText = `${m}:${s < 10 ? '0'+s : s}`;
        }

        // --- NOTES ---
        window.handleNoteInput = function() {
            window.state.notes = document.getElementById('notepad').value;
            const ind = document.getElementById('save-indicator');
            ind.style.opacity = '1';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { ind.style.opacity = '0'; window.saveData(); }, 2000);
        }

        window.exportNotes = function() {
            const text = document.getElementById('notepad').value;
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'StudyHall_Notes.txt';
            a.click();
        }

        // --- ACH ---
        window.checkAchievements = function() {
            if(!window.state.unlockedAch) window.state.unlockedAch = [];
            achievements.forEach(a => {
                if(!window.state.unlockedAch.includes(a.id) && a.req(window.state)) {
                    window.state.unlockedAch.push(a.id);
                    alert(`ACHIEVEMENT UNLOCKED: ${a.name}`);
                    window.saveData();
                }
            });
        }

        window.renderAchievements = function() {
            const row = document.getElementById('achievement-row');
            row.innerHTML = '';
            achievements.forEach(a => {
                const unlocked = window.state.unlockedAch && window.state.unlockedAch.includes(a.id);
                row.innerHTML += `
                <div class="ach-badge ${unlocked ? 'unlocked' : ''}">
                    <i class="fas ${a.icon}"></i>
                </div>`;
            });
        }

        // --- SHOP ---
        window.renderShop = function() {
            const container = document.getElementById('shop-container');
            container.innerHTML = '';
            shopItems.forEach(item => {
                const owned = window.state.inventory && window.state.inventory.includes(item.id);
                const equipped = (item.type === 'pet' ? window.state.equippedPet : window.state.equippedEffect) === item.id;
                
                let displayHTML = item.type === 'pet' 
                    ? `<div style="font-size:3rem; margin-bottom:10px;">${item.char}</div>`
                    : `<div style="font-size:2rem; margin-bottom:10px; color:var(--accent);"><i class="fas ${item.icon}"></i></div>`;

                container.innerHTML += `
                <div class="shop-item ${owned?'owned':''} ${equipped?'equipped':''}" onclick="buyItem('${item.id}', ${item.cost}, '${item.type}')">
                    <span class="item-type">${item.type.toUpperCase()}</span>
                    ${displayHTML}
                    <div style="font-weight:700;">${item.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">
                        ${owned ? (equipped ? 'EQUIPPED' : 'OWNED') : item.cost + ' Coins'}
                    </div>
                </div>`;
            });
        }

        window.buyItem = function(id, cost, type) {
            if(!window.state.inventory) window.state.inventory = [];
            if(window.state.inventory.includes(id)) {
                if(type === 'pet') window.state.equippedPet = id;
                else window.state.equippedEffect = (window.state.equippedEffect === id) ? '' : id;
            } else {
                if(window.state.coins >= cost) {
                    if(confirm(`Buy ${id} for ${cost}?`)) {
                        window.state.coins -= cost;
                        window.state.inventory.push(id);
                        if(type === 'pet') window.state.equippedPet = id;
                        else window.state.equippedEffect = id;
                    }
                } else alert("Not enough coins.");
            }
            window.saveData(); window.updateUI(); window.renderShop();
        }

        window.toggleTheme = function() {
            window.state.theme = window.state.theme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', window.state.theme);
            const bgCol = window.state.theme === 'dark' ? 'EBCB8B' : 'FF9F43';
            const txtCol = window.state.theme === 'dark' ? '2C2F36' : 'FFFFFF';
            if(window.state.avatar.includes('ui-avatars')) {
                document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=Student&background=${bgCol}&color=${txtCol}`;
            }
            window.saveData(); window.updateUI();
        }

        window.uploadAvatar = function(inp) {
            if(inp.files && inp.files[0]) {
                const r = new FileReader();
                r.onload = e => { window.state.avatar = e.target.result; document.getElementById('user-avatar').src=window.state.avatar; window.saveData(); };
                r.readAsDataURL(inp.files[0]);
            }
        }
        window.c = function(v) { const s = document.getElementById('calc-screen'); if(v==='C') s.value=''; else if(v==='=') try{s.value=eval(s.value)}catch{} else s.value+=v; }

    </script>
</body>
</html>
